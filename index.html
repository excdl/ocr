<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR App</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<script async src="https://docs.opencv.org/4.9.0/opencv.js"></script>
<style>
body {
    margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
    background: linear-gradient(135deg,#74ABE2,#5563DE); min-height:100vh; display:flex; align-items:center; justify-content:center;
}
.container {
    width:92%; max-width:480px; background:white; border-radius:16px; padding:24px;
    box-shadow:0 12px 36px rgba(0,0,0,0.2); position:relative; overflow:hidden;
    animation:fadeIn 0.8s ease-out;
}
@keyframes fadeIn {from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);}}
h2 {text-align:center; margin-bottom:20px;}
.upload-box {display:flex; gap:12px; margin-bottom:12px;}
button,label {
    background:#2979ff; color:white; border:none; padding:12px; border-radius:12px;
    cursor:pointer; font-size:16px; flex:1; box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
button:disabled,label.disabled {opacity:0.5; cursor:not-allowed;}
#previewContainer {position:relative; display:none; margin-bottom:12px;}
#previewContainer img {width:100%; border-radius:12px;}
#closePreview {position:absolute; top:8px; right:8px; background:red; color:white; border:none; border-radius:50%; width:28px; height:28px; cursor:pointer;}
video {width:100%; display:none; border-radius:12px; margin-top:12px;}
pre {background:#222; color:#0f0; padding:12px; border-radius:10px; height:180px; overflow-y:auto; margin-top:12px;}
#ocrPreview {background:#111; color:#0f0; padding:12px; border-radius:10px; height:120px; overflow-y:auto; margin-top:12px;}
</style>
</head>
<body>
<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR App</h2>
  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" class="disabled" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn" class="disabled">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>

  <div id="previewContainer">
    <img id="previewImg" src="">
    <button id="closePreview">Ã—</button>
  </div>

  <video id="camera" autoplay playsinline></video>
  <button id="capture" style="display:none; margin-top:12px;">ğŸ“¸ æ‹ç…§</button>

  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result"></pre>
  <pre id="ocrPreview">å³æ™‚ OCR é è¦½å€</pre>
</div>

<script>
let worker, workerReady=false;

cv['onRuntimeInitialized'] = async () => {
    document.getElementById("status").innerText = "OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼";
    document.getElementById("uploadBtn").classList.remove("disabled");
    document.getElementById("cameraBtn").classList.remove("disabled");
    worker = Tesseract.createWorker({
        logger: m => {
            if(m.status==='recognizing text' && m.progress){
                document.getElementById("ocrPreview").innerText = m.text || '';
            }
        }
    });
    await worker.load();
    await worker.loadLanguage('eng+chi_sim+chi_tra');
    await worker.initialize('eng+chi_sim+chi_tra');
    workerReady=true;
    document.getElementById("status").innerText += " | Tesseract å·²åˆå§‹åŒ–";
};

// å·¥å…·å‡½å¼
function imgToMat(blob){
    return new Promise(resolve=>{
        let img=new Image();
        img.onload=()=>{
            let c=document.createElement("canvas");
            c.width=img.width; c.height=img.height;
            c.getContext("2d").drawImage(img,0,0);
            resolve(cv.imread(c));
        };
        img.src=URL.createObjectURL(blob);
    });
}

function preprocessMat(mat){
    let gray=new cv.Mat();
    cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray, gray, new cv.Size(3,3),0);
    cv.adaptiveThreshold(gray, gray,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY,31,15);
    return gray;
}

function formatDate(str){
    if(str.length===6){ // YYMMDD
        let y=parseInt(str.slice(0,2),10);
        y+= y<50? 2000:1900;
        return `${y}/${str.slice(2,4)}/${str.slice(4,6)}`;
    }
    return str;
}

// OCR è­·ç…§ MRZ
async function ocrMRZ(mat){
    if(!workerReady) await worker.initialize('eng+chi_sim+chi_tra');
    let gray=preprocessMat(mat);
    const mrzY=Math.floor(gray.rows*0.7);
    const mrzH=gray.rows-mrzY;
    let roi=gray.roi(new cv.Rect(0,mrzY,gray.cols,mrzH));
    let canvas=document.createElement("canvas");
    cv.imshow(canvas,roi);
    let {data:{text}} = await worker.recognize(canvas, 'eng', { tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<', tessedit_pageseg_mode:6 });
    let clean=text.replace(/[^A-Z0-9<]/g,'');
    let data=null;
    try{
        let parsed=MRZ.parse(clean);
        if(parsed.valid){
            data={
                documentType:"Passport",
                name:parsed.fields.surname+" "+parsed.fields.givenNames,
                id:parsed.fields.documentNumber,
                nationality:parsed.fields.nationality,
                birthday:formatDate(parsed.fields.dateOfBirth),
                expiry:formatDate(parsed.fields.expirationDate),
                sex:parsed.fields.sex,
                raw:clean
            };
        }
    }catch(e){data=null;}
    roi.delete(); gray.delete();
    return data;
}

// OCR å°èƒè­‰
async function ocrTaiwanPermit(mat){
    if(!workerReady) await worker.initialize('eng+chi_sim+chi_tra');
    let gray=preprocessMat(mat);
    function roi(r){ return gray.roi(new cv.Rect(Math.floor(r.x*gray.cols),Math.floor(r.y*gray.rows),Math.floor(r.w*gray.cols),Math.floor(r.h*gray.rows))); }
    const nameROI=roi({x:0.05,y:0.10,w:0.90,h:0.15});
    const birthROI=roi({x:0.05,y:0.28,w:0.55,h:0.08});
    const expROI=roi({x:0.65,y:0.28,w:0.30,h:0.08});
    async function roiToText(roi){
        let c=document.createElement("canvas"); c.width=roi.cols; c.height=roi.rows;
        cv.imshow(c,roi);
        // æ”¾å¤§2å€å†é€ OCR
        let c2=document.createElement("canvas"); c2.width=c.width*2; c2.height=c.height*2;
        c2.getContext("2d").drawImage(c,0,0,c2.width,c2.height);
        const {data:{text}}=await worker.recognize(c2,'chi_sim');
        return text.trim();
    }
    let name=await roiToText(nameROI);
    let birthday=await roiToText(birthROI);
    let expiry=await roiToText(expROI);
    nameROI.delete(); birthROI.delete(); expROI.delete(); gray.delete();
    return {documentType:"Taiwan Compatriot Permit",name,birthday,expiry};
}

// ä¸»æµç¨‹
async function processImage(file){
    document.getElementById("ocrPreview").innerText="OCR è™•ç†ä¸­â€¦";
    const previewImg=document.getElementById("previewImg");
    const previewContainer=document.getElementById("previewContainer");
    previewImg.src=URL.createObjectURL(file);
    previewContainer.style.display="block";

    let mat=await imgToMat(file);
    let data=await ocrMRZ(mat);
    if(!data) data=await ocrTaiwanPermit(mat);
    mat.delete();
    document.getElementById("result").innerText=JSON.stringify(data,null,2);
}

// ä¸Šå‚³ & ç›¸æ©Ÿ
document.getElementById("fileInput").onchange = e => {if(e.target.files.length>0) processImage(e.target.files[0]);};

const cameraBtn=document.getElementById("cameraBtn");
const camera=document.getElementById("camera");
const capture=document.getElementById("capture");

cameraBtn.onclick=async()=>{
    if(cameraBtn.classList.contains("disabled")) return;
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    camera.srcObject=stream; camera.style.display="block"; capture.style.display="block";
};

capture.onclick=()=>{
    const c=document.createElement("canvas"); c.width=camera.videoWidth; c.height=camera.videoHeight;
    c.getContext("2d").drawImage(camera,0,0);
    c.toBlob(blob=>processImage(blob));
};

// é—œé–‰é è¦½
document.getElementById("closePreview").onclick = () => {
    document.getElementById("previewContainer").style.display="none";
    document.getElementById("fileInput").value="";
};
</script>
</body>
</html>













