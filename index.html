<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR App</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="https://docs.opencv.org/4.9.0/opencv.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:#f5f6fa;}
.container{width:92%;max-width:500px;margin:28px auto;background:linear-gradient(145deg,#2979ff,#42a5f5);border-radius:14px;padding:24px;box-shadow:0 8px 28px rgba(0,0,0,0.1);color:white;animation:fadeIn 0.6s;}
h2{text-align:center;margin-bottom:20px;}
.upload-box{display:flex;gap:12px;margin-bottom:0;}
button,label{background:#fff;color:#2979ff;border:none;padding:12px 16px;border-radius:12px;cursor:pointer;font-size:16px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:.15s;text-align:center;display:inline-block;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
video{width:100%;border-radius:12px;margin-top:12px;}
#previewContainer{position:relative;margin-top:12px;display:none;}
#uploadedImage{width:100%;border-radius:12px;display:block;}
#ocrCanvas{position:absolute;top:0;left:0;}
#closePreview{position:absolute;top:8px;right:8px;z-index:10;background:red;color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;font-weight:bold;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:220px;overflow-y:auto;margin-top:20px;}
#ocrPreview{background:#111;color:#0f0;padding:12px;border-radius:10px;height:150px;overflow-y:auto;margin-top:12px;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>

<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR App</h2>
  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>

  <div id="previewContainer">
    <button id="closePreview">âœ–</button>
    <img id="uploadedImage">
    <canvas id="ocrCanvas"></canvas>
  </div>

  <video id="camera" autoplay playsinline style="display:none;"></video>
  <button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>

  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result"></pre>
  <pre id="ocrPreview">å³æ™‚ OCR é è¦½å€</pre>
</div>

<script>
const canvas = document.getElementById("ocrCanvas");
const ctx = canvas.getContext("2d");
const uploadedImage = document.getElementById("uploadedImage");
const previewContainer = document.getElementById("previewContainer");
const closePreview = document.getElementById("closePreview");
const cameraBtn=document.getElementById("cameraBtn");
const camera=document.getElementById("camera");
const capture=document.getElementById("capture");
const uploadBtn=document.getElementById("uploadBtn");
const fileInput=document.getElementById("fileInput");

// OpenCV åˆå§‹åŒ–
cv['onRuntimeInitialized'] = () => {
    document.getElementById("status").innerText = "OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼";
};

// å·¥å…·å‡½å¼
function imgToMat(blob){
    return new Promise(resolve=>{
        let img=new Image();
        img.onload=()=>{
            let c=document.createElement("canvas");
            c.width=img.width; c.height=img.height;
            c.getContext("2d").drawImage(img,0,0);
            resolve(cv.imread(c));
        };
        img.src=URL.createObjectURL(blob);
    });
}
function preprocessMat(mat){
    let gray=new cv.Mat();
    cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray, gray, new cv.Size(3,3),0);
    cv.adaptiveThreshold(gray, gray,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY,31,15);
    return gray;
}
function formatDate(str){
    let s = str.replace(/[^\d]/g,'');
    if(s.length===8) return `${s.slice(0,4)}/${s.slice(4,6)}/${s.slice(6,8)}`;
    return str;
}
function drawRect(x,y,w,h){
    ctx.strokeStyle="lime";
    ctx.lineWidth=3;
    ctx.strokeRect(x,y,w,h);
}

// é¡¯ç¤ºåœ–ç‰‡é è¦½
fileInput.onchange = e => {
    if(e.target.files.length>0){
        let file = e.target.files[0];
        previewContainer.style.display="block";
        uploadedImage.src = URL.createObjectURL(file);
        uploadedImage.onload=()=>{
            canvas.width = uploadedImage.width;
            canvas.height = uploadedImage.height;
            ctx.clearRect(0,0,canvas.width,canvas.height);
        };
        canvas.style.display="block";
        camera.style.display="none";
        capture.style.display="none";
        uploadBtn.disabled=true;
        processImage(file);
    }
};

closePreview.onclick = () => {
    previewContainer.style.display="none";
    uploadedImage.src="";
    ctx.clearRect(0,0,canvas.width,canvas.height);
    canvas.style.display="none";
    uploadBtn.disabled=false;
};

// ç›¸æ©Ÿæ‹ç…§
cameraBtn.onclick=async()=>{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    camera.srcObject=stream; camera.style.display="block"; capture.style.display="block";
};

capture.onclick=()=>{
    const c=document.createElement("canvas"); c.width=camera.videoWidth; c.height=camera.videoHeight;
    c.getContext("2d").drawImage(camera,0,0);
    c.toBlob(blob=>processImage(blob));
};

// OCR ä¸»æµç¨‹
async function processImage(file){
    document.getElementById("ocrPreview").innerText="OCR è™•ç†ä¸­â€¦";
    let mat=await imgToMat(file);
    let data = await recognizeDocument(mat);
    mat.delete();
    document.getElementById("result").innerText=JSON.stringify(data,null,2);
}

// è­·ç…§ / å°èƒè­‰è‡ªå‹•åˆ¤æ–·
async function recognizeDocument(mat){
    let gray = preprocessMat(mat);
    const mrzY=Math.floor(gray.rows*0.75);
    const mrzH=gray.rows-mrzY;
    let roiMRZ=gray.roi(new cv.Rect(0,mrzY,gray.cols,mrzH));

    let c=document.createElement("canvas"); c.width=roiMRZ.cols; c.height=roiMRZ.rows;
    cv.imshow(c,roiMRZ);
    const { data: { text: mrzText } } = await Tesseract.recognize(c, 'eng', { tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<' });
    let cleanMRZ = mrzText.replace(/[^A-Z0-9<]/g,'');
    drawRect(0,mrzY,gray.cols,mrzH);

    try{
        let parsed = MRZ.parse(cleanMRZ);
        if(parsed.valid){
            roiMRZ.delete(); gray.delete();
            return {documentType:"Passport",name:parsed.fields.surname+" "+parsed.fields.givenNames,id:parsed.fields.documentNumber,nationality:parsed.fields.nationality,birthday:formatDate(parsed.fields.dateOfBirth),expiry:formatDate(parsed.fields.expirationDate),sex:parsed.fields.sex,raw:cleanMRZ};
        }
    }catch(e){}

    // å°èƒè­‰ OCR
    function roi(r){ return gray.roi(new cv.Rect(Math.floor(r.x*gray.cols),Math.floor(r.y*gray.rows),Math.floor(r.w*gray.cols),Math.floor(r.h*gray.rows))); }
    const nameROI=roi({x:0.05,y:0.10,w:0.90,h:0.12});
    const birthROI=roi({x:0.05,y:0.25,w:0.55,h:0.08});
    const expROI=roi({x:0.65,y:0.25,w:0.30,h:0.08});

    async function roiToText(roi){
        let c=document.createElement("canvas"); c.width=roi.cols; c.height=roi.rows;
        cv.imshow(c,roi);
        const { data: { text } } = await Tesseract.recognize(c, 'chi_sim');
        return text.trim();
    }
    let name = await roiToText(nameROI);
    let birthday = formatDate(await roiToText(birthROI));
    let expiry = formatDate(await roiToText(expROI));

    // ç•«æ¡†
    drawRect(Math.floor(0.05*canvas.width),Math.floor(0.10*canvas.height),Math.floor(0.90*canvas.width),Math.floor(0.12*canvas.height));
    drawRect(Math.floor(0.05*canvas.width),Math.floor(0.25*canvas.height),Math.floor(0.55*canvas.width),Math.floor(0.08*canvas.height));
    drawRect(Math.floor(0.65*canvas.width),Math.floor(0.25*canvas.height),Math.floor(0.30*canvas.width),Math.floor(0.08*canvas.height));

    nameROI.delete(); birthROI.delete(); expROI.delete(); gray.delete(); roiMRZ.delete();
    return {documentType:"Taiwan Compatriot Permit",name,birthday,expiry};
}
</script>
</body>
</html>














