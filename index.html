<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</title>

<!-- Tesseract -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<!-- MRZ Parser -->
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>

<!-- OpenCV -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial;
    background: #f5f6fa;
}

.container {
    width: 92%;
    max-width: 500px;
    margin: 28px auto;
    background: white;
    border-radius: 14px;
    padding: 24px;
    box-shadow: 0 8px 28px rgba(0,0,0,0.1);
}

.upload-box {
    display: flex;
    gap: 12px; /* â† æŒ‰éˆ•é–“è· */
    margin-bottom: 18px;
}

button, label {
    background: #2979ff;
    color: white;
    border: none;
    padding: 14px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 16px;
    width: 100%; /* â† è‡ªå‹•å¹³åˆ† */
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transition: .15s;
    text-align: center;
    display: inline-block;
}

button:disabled, label.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

video {
    width: 100%;
    display: none;
    border-radius: 12px;
    margin-top: 12px;
}

pre {
    background: #222;
    color: #0f0;
    padding: 12px;
    border-radius: 10px;
    height: 220px;
    overflow-y: auto;
    margin-top: 20px;
}

#loaderMask {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loader {
    border: 6px solid #ddd;
    border-top: 6px solid #2979ff;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin .9s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
.loader-text { color: white; margin-top: 16px; font-size: 18px; }

</style>
</head>

<body>

<div id="loaderMask">
  <div>
    <div class="loader"></div>
    <div class="loader-text">æ­£åœ¨è™•ç†ä¸­â€¦</div>
  </div>
</div>

<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</h2>

  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" class="disabled" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn" class="disabled">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>

  <video id="camera" autoplay playsinline></video>
  <button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>

  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result"></pre>
</div>

<script>
/* -------------------- OpenCV è¼‰å…¥æª¢æ¸¬ -------------------- */
let openCVReady = false;
let retries = 0;

function onOpenCvReady() {
    openCVReady = true;
    status.innerText = "OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼";
    uploadBtn.classList.remove("disabled");
    cameraBtn.classList.remove("disabled");
}

function checkOpenCV() {
    if (window.cv && cv.Mat) {
        onOpenCvReady();
    } else {
        retries++;
        if (retries <= 5) {
            status.innerText = `æ­£åœ¨è¼‰å…¥ OpenCVâ€¦ (${retries}/5)`;
            setTimeout(checkOpenCV, 800);
        } else {
            status.innerText = "âš  OpenCV è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚";
        }
    }
}
checkOpenCV();

/* -------------------- Loader -------------------- */
const loaderMask = document.getElementById("loaderMask");
function showLoader() { loaderMask.style.display = "flex"; }
function hideLoader() { loaderMask.style.display = "none"; }

/* -------------------- MRZ å‰è™•ç† -------------------- */
async function preprocessMRZ(blob){
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const c = document.createElement("canvas");
            c.width = img.width;
            c.height = img.height;
            c.getContext("2d").drawImage(img, 0, 0);

            let src = cv.imread(c);
            cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);

            /* å½±åƒå¼·åŒ– */
            cv.threshold(src, src, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
            cv.medianBlur(src, src, 3);

            /* ç²¾æº–æŠ“ MRZï¼ˆåº•éƒ¨ 18%ï¼‰ */
            const mrzH = Math.floor(src.rows * 0.18);
            const mrzY = src.rows - mrzH;

            let mrzMat = src.roi(new cv.Rect(0, mrzY, src.cols, mrzH));
            cv.imshow(c, mrzMat);

            mrzMat.delete();
            src.delete();

            c.toBlob(resolve, "image/jpeg");
        };
        img.src = URL.createObjectURL(blob);
    });
}

/* -------------------- MRZ OCR -------------------- */
async function recognizeMRZEnhanced(blob){
    const { data:{ text } } = await Tesseract.recognize(blob, {
        lang: "ocrb"   // MRZ å°ˆç”¨å­—å‹
    });

    let cleaned = text.replace(/[^A-Z0-9<]/g, "");

    try {
        const parsed = MRZ.parse(cleaned);
        return parsed.valid ? parsed : null;
    } catch {
        return null;
    }
}

/* -------------------- å°èƒè­‰ OCRï¼ˆåŸç¨‹å¼ä¿ç•™ï¼‰ -------------------- */
async function recognizeTaiwanPermit(blob){
    return new Promise(resolve => {
        const img = new Image();
        img.onload = async () => {
            const c = document.createElement("canvas");
            c.width = img.width;
            c.height = img.height;
            c.getContext("2d").drawImage(img, 0, 0);

            let src = cv.imread(c);
            cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(src, src, new cv.Size(3, 3), 0);
            cv.adaptiveThreshold(src, src, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 31, 15);

            const nameROI = src.roi(new cv.Rect(150, 60, src.cols-160, 60));
            const birthdayROI = src.roi(new cv.Rect(150, 120, 300, 40));
            const expiryROI = src.roi(new cv.Rect(500, 120, 200, 40));

            const canvasToBlob = (roi) => {
                const tmp = document.createElement("canvas");
                cv.imshow(tmp, roi);
                return new Promise(r => tmp.toBlob(r, "image/jpeg"));
            };

            let nameBlob = await canvasToBlob(nameROI);
            let birthdayBlob = await canvasToBlob(birthdayROI);
            let expiryBlob = await canvasToBlob(expiryROI);

            nameROI.delete(); birthdayROI.delete(); expiryROI.delete(); src.delete();

            const worker = await Tesseract.createWorker();
            await worker.loadLanguage("eng+chi_tra");
            await worker.initialize("eng+chi_tra");

            let name = (await worker.recognize(nameBlob)).data.text.trim();
            let birthday = (await worker.recognize(birthdayBlob)).data.text.trim();
            let expiry = (await worker.recognize(expiryBlob)).data.text.trim();
            await worker.terminate();

            resolve({name, birthday, expiry});
        };
        img.src = URL.createObjectURL(blob);
    });
}

/* -------------------- ä¸»æµç¨‹ -------------------- */
async function processImage(file){
    showLoader();
    status.innerText = "å½±åƒè™•ç†ä¸­â€¦";

    const processed = await preprocessMRZ(file);

    status.innerText = "è­·ç…§ MRZ è¾¨è­˜ä¸­â€¦";
    let mrz = await recognizeMRZEnhanced(processed);

    let data = {};

    if (mrz) {
        status.innerText = "âœ“ è­·ç…§è¾¨è­˜æˆåŠŸï¼";

        data = {
            documentType: "Passport",
            name: mrz.fields.surname + " " + mrz.fields.givenNames,
            id: mrz.fields.documentNumber,
            nationality: mrz.fields.nationality,
            birthday: mrz.fields.dateOfBirth,
            expiry: mrz.fields.expirationDate,
            sex: mrz.fields.sex
        };

        result.innerText = JSON.stringify(data, null, 2);
    } else {
        status.innerText = "å°èƒè­‰ OCR è¾¨è­˜ä¸­â€¦";

        data = await recognizeTaiwanPermit(file);
        data.documentType = "Taiwan Compatriot Permit";

        result.innerText = JSON.stringify(data, null, 2);
    }

    hideLoader();
}

/* -------------------- ä¸Šå‚³åœ–ç‰‡ -------------------- */
fileInput.onchange = e => {
    if (e.target.files.length > 0) {
        processImage(e.target.files[0]);
    }
};

/* -------------------- ç›¸æ©Ÿæ‹ç…§ï¼ˆä½¿ç”¨å¾Œé¡é ­ï¼‰ -------------------- */
cameraBtn.onclick = async () => {
    if (cameraBtn.classList.contains("disabled")) return;

    let constraints = { video: { facingMode: { exact: "environment" } } };

    try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        camera.srcObject = stream;
    } catch(e) {
        // fallback ç”¨å‰é¡é ­
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        camera.srcObject = stream;
    }

    camera.style.display = "block";
    capture.style.display = "block";
};

/* -------------------- æ‹ç…§ -------------------- */
capture.onclick = () => {
    const c = document.createElement("canvas");
    c.width = camera.videoWidth;
    c.height = camera.videoHeight;

    c.getContext("2d").drawImage(camera, 0, 0);

    c.toBlob(blob => processImage(blob));
};
</script>

</body>
</html>







