<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR App</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.9.0/opencv.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:linear-gradient(135deg,#6b73ff,#000dff);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding-top:40px;}
.container{width:92%;max-width:500px;background:white;border-radius:20px;padding:24px;box-shadow:0 8px 28px rgba(0,0,0,0.2);animation:fadeIn 0.8s;}
@keyframes fadeIn{0%{opacity:0;transform:translateY(-20px);}100%{opacity:1;transform:translateY(0);}}
h2{text-align:center;margin-bottom:24px;}
.upload-box{display:flex;gap:12px;margin-bottom:18px;transition:margin 0.3s;}
button,label{background:#2979ff;color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-size:16px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:.2s;text-align:center;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
#previewBox{position:relative;margin-top:12px;display:none;}
#previewBox img{width:100%;border-radius:12px;}
#closePreview{position:absolute;top:6px;right:6px;background:red;color:white;border:none;border-radius:50%;width:28px;height:28px;font-weight:bold;cursor:pointer;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:180px;overflow-y:auto;margin-top:12px;}
</style>
</head>
<body>
<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR App</h2>
  <div class="upload-box" id="uploadBox">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" class="disabled" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn" class="disabled">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>

  <div id="previewBox">
    <button id="closePreview">âœ–</button>
    <img id="previewImg">
  </div>

  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result">è¾¨è­˜çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</pre>
</div>

<script>
let worker, workerReady=false;

// ===================== OpenCV åˆå§‹åŒ– =====================
cv['onRuntimeInitialized'] = async () => {
    document.getElementById("status").innerText = "OpenCV è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ– Tesseractâ€¦";

    worker = Tesseract.createWorker({logger:m=>console.log(m)});

    try{
        await worker.load();
        await worker.loadLanguage('eng+chi_tra+chi_sim');
        await worker.initialize('eng+chi_tra+chi_sim');
        workerReady=true;
        document.getElementById("status").innerText = "OpenCV + Tesseract åˆå§‹åŒ–å®Œæˆ";
        document.getElementById("uploadBtn").classList.remove("disabled");
        document.getElementById("cameraBtn").classList.remove("disabled");
    }catch(e){
        console.error("Tesseract åˆå§‹åŒ–å¤±æ•—", e);
        document.getElementById("status").innerText = "Tesseract åˆå§‹åŒ–å¤±æ•—";
    }
};

// ===================== å·¥å…·å‡½å¼ =====================
function imgToCanvas(file){
    return new Promise(resolve=>{
        const img = new Image();
        img.onload=()=>{
            const c=document.createElement("canvas");
            c.width=img.width; c.height=img.height;
            c.getContext("2d").drawImage(img,0,0);
            resolve(c);
        };
        img.src=URL.createObjectURL(file);
    });
}

function formatBirthday(str){
    const digits = str.replace(/[^\d]/g,'');
    if(digits.length===6){
        return '19'+digits.slice(0,2)+'/'+digits.slice(2,4)+'/'+digits.slice(4,6);
    }else if(digits.length===8){
        return digits.slice(0,4)+'/'+digits.slice(4,6)+'/'+digits.slice(6,8);
    }
    return str;
}

// ===================== OCR ä¸»æµç¨‹ =====================
async function processImage(file){
    if(!workerReady) return alert("Tesseract å°šæœªåˆå§‹åŒ–");
    document.getElementById("status").innerText="OCR è¾¨è­˜ä¸­â€¦";
    const canvas = await imgToCanvas(file);

    const { data: { text } } = await worker.recognize(canvas);

    let result={raw:text};

    // å˜—è©¦ MRZ è¾¨è­˜
    try{
        const mrz = MRZ.parse(text.replace(/\s/g,''));
        if(mrz.valid){
            result.documentType="Passport";
            result.name = mrz.fields.surname + " " + mrz.fields.givenNames;
            result.id = mrz.fields.documentNumber;
            result.nationality = mrz.fields.nationality;
            result.birthday = formatBirthday(mrz.fields.dateOfBirth);
            result.expiry = formatBirthday(mrz.fields.expirationDate);
            result.sex = mrz.fields.sex;
        } else {
            // å°èƒè­‰ç°¡å–® OCR
            result.documentType="Taiwan Compatriot Permit";
            let lines = text.split(/\n/).map(l=>l.trim()).filter(l=>l);
            result.name = lines[0] || '';
            result.birthday = formatBirthday(lines[1]||'');
            result.expiry = formatBirthday(lines[2]||'');
        }
    }catch(e){
        console.warn("MRZ è§£æå¤±æ•—", e);
        result.documentType="Unknown";
    }

    document.getElementById("result").innerText=JSON.stringify(result,null,2);
    document.getElementById("status").innerText="OCR å®Œæˆ";
}

// ===================== ä¸Šå‚³ & é è¦½ =====================
const fileInput=document.getElementById("fileInput");
const uploadBtn=document.getElementById("uploadBtn");
const previewBox=document.getElementById("previewBox");
const previewImg=document.getElementById("previewImg");
const closePreview=document.getElementById("closePreview");

fileInput.onchange=async e=>{
    if(e.target.files.length===0) return;
    const file = e.target.files[0];
    previewImg.src = URL.createObjectURL(file);
    previewBox.style.display="block";
    document.getElementById("uploadBox").style.marginBottom="12px";
    await processImage(file);
};

closePreview.onclick=()=>{
    previewBox.style.display="none";
    previewImg.src="";
    fileInput.value="";
    document.getElementById("uploadBox").style.marginBottom="18px";
};

// ===================== ç›¸æ©Ÿæ‹ç…§ =====================
const cameraBtn=document.getElementById("cameraBtn");
cameraBtn.onclick=async()=>{
    if(cameraBtn.classList.contains("disabled")) return;
    alert("ç›¸æ©ŸåŠŸèƒ½å¯ä¾éœ€æ±‚å¢åŠ ï¼Œç›®å‰å…ˆç”¨ä¸Šå‚³æ¸¬è©¦ OCR");
};
</script>
</body>
</html>












