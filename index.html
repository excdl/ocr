<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>護照 / 台胞證 OCR MRZ + Google Sheet</title>
<style>
body{font-family:Arial,sans-serif;background:#f0f0f0;padding:20px;}
.container{max-width:480px;margin:auto;background:white;padding:20px;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.1);}
button,input{padding:10px 14px;margin:5px 0;border-radius:8px;border:1px solid #ccc;cursor:pointer;}
canvas{display:block;margin-top:10px;}
pre{background:#222;color:#0f0;padding:10px;border-radius:8px;overflow:auto;}
video{display:none;}
</style>
</head>
<body>
<div class="container">
<h2>護照 / 台胞證 OCR MRZ + Google Sheet</h2>
<input type="file" id="fileInput" accept="image/*">
<button id="cameraBtn">拍照 OCR</button>

<canvas id="canvas"></canvas>
<pre id="status">狀態: 等待操作</pre>
<pre id="result">辨識結果將顯示於此</pre>
<video id="videoElement" autoplay playsinline></video>
</div>

<script>
const OCR_API_KEY = 'YOUR_OCR_SPACE_KEY'; // <-- 換成你的 OCR.Space API Key
const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL'; // <-- 換成你的 Google Apps Script URL

const fileInput = document.getElementById("fileInput");
const cameraBtn = document.getElementById("cameraBtn");
const canvas = document.getElementById("canvas");
const status = document.getElementById("status");
const resultPre = document.getElementById("result");
const videoElement = document.getElementById("videoElement");

// -------------------- 工具函數 --------------------
function resizeImage(img,maxWidth=1024){
    if(img.width <= maxWidth) return img;
    const ratio = maxWidth / img.width;
    const tmpCanvas = document.createElement("canvas");
    tmpCanvas.width = img.width*ratio;
    tmpCanvas.height = img.height*ratio;
    tmpCanvas.getContext("2d").drawImage(img,0,0,tmpCanvas.width,tmpCanvas.height);
    const resizedImg = new Image();
    resizedImg.src = tmpCanvas.toDataURL("image/png");
    return resizedImg;
}

function cropMRZ(img){
    const w = img.width || img.videoWidth;
    const h = img.height || img.videoHeight;
    const mrzHeight = h/3;
    canvas.width = w;
    canvas.height = mrzHeight;
    const ctx = canvas.getContext("2d");
    ctx.filter = "contrast(180%) brightness(120%) grayscale()";
    ctx.drawImage(img,0,h-mrzHeight,w,mrzHeight,0,0,w,mrzHeight);
    return canvas;
}

async function doOCR(croppedCanvas){
    status.innerText = "辨識中...";
    const blob = await new Promise(r=>croppedCanvas.toBlob(r,'image/png'));
    const formData = new FormData();
    formData.append("apikey", OCR_API_KEY);
    formData.append("language","OCRB");
    formData.append("isOverlayRequired","false");
    formData.append("file", blob);

    try{
        const res = await fetch("https://api.ocr.space/parse/image",{method:"POST",body:formData});
        const data = await res.json();
        if(data.ParsedResults && data.ParsedResults.length>0){
            const text = data.ParsedResults[0].ParsedText.replace(/\s/g,'');
            status.innerText = "辨識完成 ✅";
            parseMRZ(text);
        } else {
            status.innerText = "OCR 失敗 ❌";
            resultPre.innerText = "OCR 失敗，請檢查圖片";
        }
    }catch(e){
        status.innerText = "OCR 失敗 ❌";
        console.error(e);
    }
}

// -------------------- MRZ 智能解析 --------------------
function parseMRZ(text){
    text = text.replace(/\s/g,'');
    let result = {rawMRZ:text};

    // Passport MRZ (2行44字符)
    if(text.length===88 && text.startsWith('P')){
        result.documentType = "Passport";
        const lines = text.match(/.{44}/g);
        result.id = lines[0].substring(5,14).replace(/</g,'');
        result.nationality = lines[0].substring(10,13);
        result.name = lines[0].substring(5).split("<<").slice(1).map(s=>s.replace(/</g,' ')).join(" ");
        result.birthday = formatDate(lines[1].substring(0,6));
        result.sex = lines[1].substring(7,8)==='M'?'男':'女';
        result.expiry = formatDate(lines[1].substring(8,14));
    } 
    // Taiwan Compatriot Permit / Visa / ID (2行30字符)
    else if(text.length===60){
        result.documentType = "Taiwan Compatriot Permit or Visa";
        const lines = text.match(/.{30}/g);
        result.id = lines[0].substring(0,9).replace(/</g,'');
        result.name = lines[0].substring(10).replace(/</g,' ').trim();
        result.birthday = formatDate(lines[1].substring(0,6));
        result.expiry = formatDate(lines[1].substring(8,14));
        result.sex = lines[1].substring(7,8)==='M'?'男':'女';
    } 
    else {
        result.documentType = "Unknown MRZ Format";
        const lines = text.match(/.{1,44}/g);
        if(lines && lines.length>=2){
            result.name = lines[0].split("<<").slice(1).map(s=>s.replace(/</g,' ')).join(" ");
            result.id = lines[0].substring(5,14).replace(/</g,'');
        }
    }

    resultPre.innerText = "OCR 結果:\n"+text+"\n\n解析結果:\n"+JSON.stringify(result,null,2);
    sendToSheet(result);
}

function formatDate(str){
    if(str.length===6){
        let year=parseInt(str.slice(0,2));
        year += year>=50?1900:2000;
        return `${year}/${str.slice(2,4)}/${str.slice(4,6)}`;
    }
    return str;
}

// -------------------- Google Sheet --------------------
async function sendToSheet(data){
    if(!data) return;
    try{
        const res = await fetch(SCRIPT_URL,{
            method:'POST',
            body: JSON.stringify(data),
            headers:{'Content-Type':'application/json'}
        });
        status.innerText = res.ok ? "已送出至 Google Sheet ✅" : "送出失敗 ⚠️";
    }catch(e){
        status.innerText = "送出失敗 ⚠️";
        console.error(e);
    }
}

// -------------------- 上傳圖片 --------------------
fileInput.onchange = e => {
    if(e.target.files.length===0) return;
    const img = new Image();
    img.onload = async ()=>{
        const resized = resizeImage(img);
        resized.onload = async ()=>{
            cropMRZ(resized);
            await doOCR(canvas);
        };
    };
    img.src = URL.createObjectURL(e.target.files[0]);
};

// -------------------- 拍照 OCR --------------------
cameraBtn.onclick = async ()=>{
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        videoElement.srcObject = stream;
        videoElement.style.display = "block";
        await new Promise(r=>videoElement.play());
        status.innerText = "對準護照或台胞證，等待 2 秒自動拍照...";
        await new Promise(r=>setTimeout(r,2000));
        cropMRZ(videoElement);
        stream.getTracks().forEach(t=>t.stop());
        await doOCR(canvas);
    }catch(e){
        status.innerText = "無法開啟相機 ❌";
        console.error(e);
    }
};
</script>
</body>
</html>

















































