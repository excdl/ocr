<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR App</title>
<script src="https://cdn.jsdelivr.net/npm/opencv.js@4.9.0/opencv.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:linear-gradient(135deg,#4facfe,#00f2fe);}
.container{width:92%;max-width:900px;margin:28px auto;background:white;border-radius:18px;padding:24px;box-shadow:0 12px 28px rgba(0,0,0,0.15);}
h2{text-align:center;color:#333;}
.upload-box{display:flex;gap:10px;margin-bottom:12px;}
button,label{background:#2979ff;color:white;border:none;padding:12px 18px;border-radius:12px;cursor:pointer;font-size:16px;flex:1;text-align:center;transition:.2s;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
.preview-container{display:flex;gap:12px;position:relative;}
canvas{border-radius:12px;width:48%;height:auto;background:#eee;}
#ocrPreview{position:absolute;top:0;right:0;background:rgba(0,0,0,0.8);color:#0f0;padding:8px;border-radius:8px;max-width:40%;max-height:40%;overflow:auto;font-family:monospace;}
#status,pre{margin-top:12px;}
</style>
</head>
<body>
<div class="container">
<h2>è­·ç…§ / å°èƒè­‰ OCR App</h2>
<div class="upload-box">
<input type="file" id="fileInput" accept="image/*" hidden>
<label id="uploadBtn" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
<button id="cameraBtn">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
</div>

<div class="preview-container">
<canvas id="fullCanvas"></canvas>
<canvas id="mrzCanvas"></canvas>
<div id="ocrPreview">OCR é è¦½</div>
</div>

<video id="camera" autoplay playsinline style="display:none;"></video>
<button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>

<p id="status">è¼‰å…¥ OpenCVâ€¦</p>
<pre id="result">è¾¨è­˜çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</pre>
</div>

<script>
const status = document.getElementById('status');
const fullCanvas = document.getElementById('fullCanvas');
const mrzCanvasElement = document.getElementById('mrzCanvas');
const ocrPreview = document.getElementById('ocrPreview');
const resultPre = document.getElementById('result');
const fileInput = document.getElementById('fileInput');
const camera = document.getElementById('camera');
const capture = document.getElementById('capture');
let liveOCRInterval = null;

// MRZ å€åŸŸåµæ¸¬
function extractMRZRegion(canvas){
    try{
        let src = cv.imread(canvas);
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

        let clahe = new cv.CLAHE(2.0, new cv.Size(8,8));
        let enhanced = new cv.Mat();
        clahe.apply(gray, enhanced);

        const blur = new cv.Mat();
        cv.GaussianBlur(enhanced, blur, new cv.Size(3,3), 0);
        const thresh = new cv.Mat();
        cv.threshold(blur, thresh, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

        const contours = new cv.MatVector();
        const hierarchy = new cv.Mat();
        cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let mrzRect = null;
        for(let i=0;i<contours.size();i++){
            let cnt = contours.get(i);
            let rect = cv.boundingRect(cnt);
            if(rect.width > rect.height*5 && rect.y > src.rows*0.5){
                if(!mrzRect || rect.y>mrzRect.y) mrzRect = rect;
            }
        }

        // fullCanvas é¡¯ç¤ºç´…æ¡†
        const ctxFull = fullCanvas.getContext('2d');
        fullCanvas.width = canvas.width;
        fullCanvas.height = canvas.height;
        ctxFull.drawImage(canvas,0,0);
        if(mrzRect){
            ctxFull.strokeStyle='red';
            ctxFull.lineWidth=4;
            ctxFull.strokeRect(mrzRect.x, mrzRect.y, mrzRect.width, mrzRect.height);
        }

        // è£åˆ‡ MRZ
        let mrzCanvas = document.createElement('canvas');
        if(mrzRect){
            mrzCanvas.width = mrzRect.width;
            mrzCanvas.height = mrzRect.height;
            const ctx = mrzCanvas.getContext('2d');
            ctx.drawImage(canvas, mrzRect.x, mrzRect.y, mrzRect.width, mrzRect.height, 0,0,mrzRect.width, mrzRect.height);
        } else {
            mrzCanvas.width = canvas.width;
            mrzCanvas.height = canvas.height;
            mrzCanvas.getContext('2d').drawImage(canvas,0,0);
        }

        src.delete(); gray.delete(); enhanced.delete(); blur.delete(); thresh.delete(); contours.delete(); hierarchy.delete(); clahe.delete();
        return mrzCanvas;
    }catch(e){ console.error("MRZ åµæ¸¬å¤±æ•—:", e); return canvas; }
}

// ä¸Šå‚³åœ–ç‰‡
fileInput.onchange = e=>{
    if(e.target.files.length>0){
        const img = new Image();
        img.onload = ()=>{ displayCanvas(img); };
        img.src = URL.createObjectURL(e.target.files[0]);
    }
};

function displayCanvas(img){
    fullCanvas.width = img.width;
    fullCanvas.height = img.height;
    fullCanvas.getContext('2d').drawImage(img,0,0);
    const mrzCanvas = extractMRZRegion(img);
    mrzCanvasElement.width = mrzCanvas.width;
    mrzCanvasElement.height = mrzCanvas.height;
    mrzCanvasElement.getContext('2d').drawImage(mrzCanvas,0,0);
    ocrPreview.innerText="OCR éœ€ Tesseract æˆ– Google Vision API ä¾†è¾¨è­˜";
}

// ç›¸æ©Ÿ
document.getElementById("cameraBtn").onclick = async ()=>{
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        camera.srcObject = stream;
        camera.style.display='block';
        capture.style.display='block';
        if(liveOCRInterval) clearInterval(liveOCRInterval);
        liveOCRInterval = setInterval(()=>{
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = camera.videoWidth;
            tempCanvas.height = camera.videoHeight;
            tempCanvas.getContext('2d').drawImage(camera,0,0);
            displayCanvas(tempCanvas);
        },500);
    }catch(e){ console.error(e); status.innerText="ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ"; }
};

capture.onclick = ()=>{
    if(liveOCRInterval){ clearInterval(liveOCRInterval); liveOCRInterval=null; }
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = camera.videoWidth;
    tempCanvas.height = camera.videoHeight;
    tempCanvas.getContext('2d').drawImage(camera,0,0);
    displayCanvas(tempCanvas);
};

// åˆå§‹åŒ– OpenCV
function checkOpenCV(){
    if(typeof cv==='undefined'){
        status.innerText="OpenCV è¼‰å…¥å¤±æ•— âŒï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
    } else {
        cv['onRuntimeInitialized'] = ()=>{ status.innerText="OpenCV è¼‰å…¥å®Œæˆ âœ…"; };
    }
}
checkOpenCV();
</script>
</body>
</html>













