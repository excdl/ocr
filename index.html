<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR å³æ™‚é è¦½ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<script src="https://docs.opencv.org/4.9.0/opencv.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:#f5f6fa;}
.container{width:92%;max-width:500px;margin:28px auto;background:white;border-radius:14px;padding:24px;box-shadow:0 8px 28px rgba(0,0,0,0.1);}
.upload-box{display:flex;gap:12px;margin-bottom:18px;}
button,label{background:#2979ff;color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-size:16px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:.15s;text-align:center;display:inline-block;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
video{width:100%;display:none;border-radius:12px;margin-top:12px;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:220px;overflow-y:auto;margin-top:20px;}
#ocrPreview{background:#111;color:#0f0;padding:12px;border-radius:10px;height:150px;overflow-y:auto;margin-top:12px;}
</style>
</head>
<body>

<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR å³æ™‚é è¦½ç‰ˆ</h2>
  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" class="disabled" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn" class="disabled">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>
  <video id="camera" autoplay playsinline></video>
  <button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>
  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result"></pre>
  <pre id="ocrPreview">å³æ™‚ OCR é è¦½å€</pre>
</div>

<script>
let worker, workerReady = false;

// ===============================
// OpenCV åˆå§‹åŒ–
// ===============================
cv['onRuntimeInitialized'] = () => {
    document.getElementById("status").innerText = "OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼";
    document.getElementById("uploadBtn").classList.remove("disabled");
    document.getElementById("cameraBtn").classList.remove("disabled");
    initWorker(); // OpenCV è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ– Tesseract
};

// ===============================
// Tesseract Worker åˆå§‹åŒ–
// ===============================
async function initWorker(){
    worker = Tesseract.createWorker({
        logger: m => {
            if(m.status==='recognizing text' && m.progress){
                document.getElementById("ocrPreview").innerText = m.text || '';
            }
        }
    });
    await worker.load();
    await worker.loadLanguage('eng+chi_tra');
    await worker.initialize('eng+chi_tra');
    workerReady = true;
    document.getElementById("status").innerText += " | Tesseract å·²åˆå§‹åŒ–";
}

// ===============================
// å·¥å…·å‡½å¼
// ===============================
function imgToMat(blob){
    return new Promise(resolve=>{
        let img=new Image();
        img.onload=()=>{
            let c=document.createElement("canvas");
            c.width=img.width; c.height=img.height;
            c.getContext("2d").drawImage(img,0,0);
            resolve(cv.imread(c));
        };
        img.src=URL.createObjectURL(blob);
    });
}
function autoRotateMat(src){
    let rotated = src.clone();
    if(src.cols < src.rows){
        let M = cv.getRotationMatrix2D(new cv.Point(src.cols/2, src.rows/2), 90,1);
        let dst = new cv.Mat();
        cv.warpAffine(src,dst,M,new cv.Size(src.rows, src.cols));
        rotated.delete(); M.delete();
        rotated = dst;
    }
    return rotated;
}

// ===============================
// OCR å‡½å¼
// ===============================
async function ocrMRZ(mat){
    if(!workerReady) await initWorker();
    let rotated = autoRotateMat(mat);
    const mrzY = Math.floor(rotated.rows*0.75);
    const mrzH = rotated.rows - mrzY;
    let mrzMat = rotated.roi(new cv.Rect(0,mrzY,rotated.cols,mrzH));
    cv.cvtColor(mrzMat, mrzMat, cv.COLOR_RGBA2GRAY);
    let scale = 600 / mrzMat.cols;
    cv.resize(mrzMat, mrzMat, new cv.Size(600, Math.floor(mrzMat.rows*scale)));
    cv.threshold(mrzMat,mrzMat,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);
    let canvas=document.createElement("canvas");
    cv.imshow(canvas,mrzMat);
    let blob=await new Promise(r=>canvas.toBlob(r,"image/png"));
    let data=null;
    try{
        const { data:{text} } = await worker.recognize(blob,{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'} );
        let clean=text.replace(/[^A-Z0-9<]/g,'');
        document.getElementById("ocrPreview").innerText=clean;
        try{
            let parsed=MRZ.parse(clean);
            if(parsed.valid){
                data={documentType:"Passport",name:parsed.fields.surname+" "+parsed.fields.givenNames,id:parsed.fields.documentNumber,nationality:parsed.fields.nationality,birthday:parsed.fields.dateOfBirth,expiry:parsed.fields.expirationDate,sex:parsed.fields.sex,raw:clean};
            }
        }catch(e){data=null;}
    }catch(e){data=null;}
    rotated.delete(); mrzMat.delete();
    return data;
}

async function ocrTaiwanPermit(mat){
    if(!workerReady) await initWorker();
    let rotated = autoRotateMat(mat);
    let gray = new cv.Mat();
    cv.cvtColor(rotated,gray,cv.COLOR_RGBA2GRAY);
    cv.threshold(gray,gray,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);
    function roi(r){ return gray.roi(new cv.Rect(Math.floor(r.x*gray.cols),Math.floor(r.y*gray.rows),Math.floor(r.w*gray.cols),Math.floor(r.h*gray.rows))); }
    const nameROI=roi({x:0.05,y:0.10,w:0.90,h:0.12});
    const birthROI=roi({x:0.05,y:0.25,w:0.55,h:0.08});
    const expROI=roi({x:0.65,y:0.25,w:0.30,h:0.08});
    async function roiToText(roi){
        let c=document.createElement("canvas"); c.width=roi.cols; c.height=roi.rows;
        cv.imshow(c,roi);
        let blob=await new Promise(r=>c.toBlob(r,"image/png"));
        const {data:{text}} = await worker.recognize(blob);
        return text.trim();
    }
    let name=await roiToText(nameROI);
    let birthday=await roiToText(birthROI);
    let expiry=await roiToText(expROI);
    nameROI.delete(); birthROI.delete(); expROI.delete(); gray.delete(); rotated.delete();
    return {documentType:"Taiwan Compatriot Permit",name,birthday,expiry};
}

// ===============================
// ä¸»æµç¨‹
// ===============================
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzUEqAK6KuVQQ1gH05j_plXcq2jIuY5-fiOeseNhjImN-PwppMA_-RGi1ao7x5rQ5yJ/exec";
async function processImage(file){
    if(!workerReady) await initWorker();
    document.getElementById("ocrPreview").innerText="å³æ™‚ OCR è™•ç†ä¸­â€¦";
    let mat=await imgToMat(file);
    let mrzData=await ocrMRZ(mat);
    let finalData=null;
    if(mrzData){finalData=mrzData;}
    else{finalData=await ocrTaiwanPermit(mat);}
    mat.delete();
    document.getElementById("result").innerText=JSON.stringify(finalData,null,2);
    await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(finalData)});
}

// ===============================
// ä¸Šå‚³ & ç›¸æ©Ÿ
// ===============================
document.getElementById("fileInput").onchange = e => {if(e.target.files.length>0) processImage(e.target.files[0]);};
const cameraBtn=document.getElementById("cameraBtn");
const camera=document.getElementById("camera");
const capture=document.getElementById("capture");

cameraBtn.onclick=async()=>{
    if(cameraBtn.classList.contains("disabled")) return;
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    camera.srcObject=stream; camera.style.display="block"; capture.style.display="block";

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    function updatePreview(){
        if(camera.videoWidth && camera.videoHeight){
            canvas.width=camera.videoWidth; canvas.height=camera.videoHeight;
            ctx.drawImage(camera,0,0);
            canvas.toBlob(blob => processImage(blob));
        }
        requestAnimationFrame(updatePreview);
    }
    updatePreview();
};

capture.onclick=()=>{
    const c=document.createElement("canvas"); c.width=camera.videoWidth; c.height=camera.videoHeight;
    c.getContext("2d").drawImage(camera,0,0);
    c.toBlob(blob=>processImage(blob));
};
</script>
</body>
</html>










