<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR å³æ™‚ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:linear-gradient(135deg,#4facfe,#00f2fe);}
.container{width:95%;max-width:600px;margin:20px auto;background:white;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.15);}
h1{text-align:center;color:#333;}
.camera-box{display:flex;gap:10px;margin-bottom:12px;}
button{background:#2979ff;color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;flex:1;text-align:center;}
button:disabled{opacity:0.5;cursor:not-allowed;}
canvas,video{width:100%;border-radius:10px;display:none;margin-top:10px;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:150px;overflow-y:auto;font-family:monospace;}
</style>
</head>
<body>
<div class="container">
<h1>è­·ç…§ / å°èƒè­‰ OCR å³æ™‚ç‰ˆ</h1>

<div class="camera-box">
<button id="cameraBtn" disabled>ğŸ“· è«‹ç­‰å¾… Tesseract åˆå§‹åŒ–â€¦</button>
<button id="captureBtn" disabled>ğŸ“¸ æ‹ç…§ OCR</button>
</div>

<video id="camera" autoplay playsinline></video>
<canvas id="previewCanvas"></canvas>
<pre id="ocrPreview">OCR é è¦½</pre>
<p id="status">Tesseract å°šæœªåˆå§‹åŒ– âŒ</p>
</div>

<script>
const SCRIPT_URL="YOUR_GOOGLE_SCRIPT_URL"; // <-- æ›æˆä½ çš„ Google Apps Script URL
let worker, workerReady=false;

const status=document.getElementById("status");
const ocrPreview=document.getElementById("ocrPreview");
const previewCanvas=document.getElementById("previewCanvas");
const cameraBtn=document.getElementById("cameraBtn");
const captureBtn=document.getElementById("captureBtn");
const camera=document.getElementById("camera");

// ç”Ÿæ—¥æ ¼å¼åŒ–
function formatBirthday(str){
    let clean=str.replace(/[^\d]/g,'');
    if(clean.length===6) return '19'+clean.slice(0,2)+'/'+clean.slice(2,4)+'/'+clean.slice(4,6);
    if(clean.length===8) return clean.slice(0,4)+'/'+clean.slice(4,6)+'/'+clean.slice(6,8);
    return str;
}

// åˆå§‹åŒ– Tesseract
async function initTesseract(){
    try{
        status.innerText="Tesseract åˆå§‹åŒ–ä¸­â€¦";
        worker=Tesseract.createWorker({
            logger:m=>{ if(m.status==='recognizing text') ocrPreview.innerText=m.text||''; }
        });
        await worker.load();
        await worker.loadLanguage('eng+chi_tra+chi_sim');
        await worker.initialize('eng+chi_tra+chi_sim');
        workerReady=true;
        status.innerText="Tesseract åˆå§‹åŒ–å®Œæˆ âœ…";
        cameraBtn.disabled=false;
        captureBtn.disabled=false;
    }catch(e){
        console.error("Tesseract åˆå§‹åŒ–å¤±æ•—:", e);
        status.innerText="Tesseract åˆå§‹åŒ–å¤±æ•— âŒ";
    }
}

// OCR è™•ç†
async function processCanvas(canvas){
    if(!workerReady){ alert("Tesseract å°šæœªå°±ç·’"); return; }
    try{
        const { data:{ text } } = await worker.recognize(canvas);
        ocrPreview.innerText=text.trim().slice(0,300);

        let result={raw:text};
        let mrzText=text.replace(/\s/g,'');
        try{
            const mrz=MRZ.parse(mrzText);
            if(mrz.valid){
                result.documentType="Passport";
                result.name=mrz.fields.surname+" "+mrz.fields.givenNames;
                result.id=mrz.fields.documentNumber;
                result.nationality=mrz.fields.nationality;
                result.birthday=formatBirthday(mrz.fields.dateOfBirth);
                result.expiry=formatBirthday(mrz.fields.expirationDate);
                result.sex=mrz.fields.sex;
            }else{
                result.documentType="Taiwan Compatriot Permit";
                let lines=text.split(/\n/).map(l=>l.trim()).filter(l=>l);
                result.name=lines[0]||'';
                result.birthday=formatBirthday(lines[1]||'');
                result.expiry=formatBirthday(lines[2]||'');
            }
        }catch(e){
            console.warn("MRZ è§£æå¤±æ•—:", e);
            result.documentType="Unknown";
        }

        // é€ Google Sheet
        try{
            const res = await fetch(SCRIPT_URL,{
                method:'POST',
                body:JSON.stringify(result),
                headers:{'Content-Type':'application/json'}
            });
            if(res.ok) status.innerText="å·²é€å‡ºè‡³ Google Sheet âœ…";
            else status.innerText="é€å‡º Google Sheet å¤±æ•— âš ï¸";
        }catch(e){
            console.error("é€å‡º Google Sheet å¤±æ•—:", e);
            status.innerText="é€å‡º Google Sheet å¤±æ•— âš ï¸";
        }

    }catch(e){
        console.error("OCR å¤±æ•—:", e);
        status.innerText="OCR å¤±æ•— âŒ";
    }
}

// æ‰“é–‹ç›¸æ©Ÿ
cameraBtn.onclick=async()=>{
    try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        camera.srcObject=stream;
        camera.style.display='block';
        previewCanvas.style.display='block';
    }catch(e){
        alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ âŒ");
        console.error(e);
    }
};

// æ‹ç…§ OCR
captureBtn.onclick=()=>{
    if(!workerReady){ alert("Tesseract å°šæœªå°±ç·’"); return; }
    const ctx=previewCanvas.getContext('2d');
    previewCanvas.width=camera.videoWidth;
    previewCanvas.height=camera.videoHeight;
    ctx.drawImage(camera,0,0);
    processCanvas(previewCanvas);
};

// åˆå§‹åŒ–
window.onload = initTesseract;
</script>
</body>
</html>


















































