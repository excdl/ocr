<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR App</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<script async src="https://docs.opencv.org/4.9.0/opencv.js"></script>
<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
  background:linear-gradient(135deg,#4facfe,#00f2fe);
}
.container{
  width:92%;
  max-width:480px;
  margin:28px auto;
  background:white;
  border-radius:18px;
  padding:24px;
  box-shadow:0 12px 28px rgba(0,0,0,0.15);
  animation:fadeIn 0.6s;
}
@keyframes fadeIn{
  from {opacity:0;transform:translateY(-20px);}
  to {opacity:1;transform:translateY(0);}
}
h2{margin-top:0;text-align:center;color:#333;}
.upload-box{display:flex;gap:10px;margin-bottom:12px;}
button,label{
  background:#2979ff;
  color:white;
  border:none;
  padding:12px 18px;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  flex:1;
  text-align:center;
  transition:.2s;
}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
video,canvas{width:100%;border-radius:12px;display:none;margin-top:12px;}
#ocrPreview,pre{
  background:#222;color:#0f0;padding:12px;
  border-radius:10px;
  height:150px;overflow-y:auto;margin-top:12px;font-family:monospace;
}
.close-preview{
  position:absolute;top:8px;right:8px;background:red;color:white;padding:2px 6px;border-radius:6px;cursor:pointer;font-size:14px;
}
.preview-container{position:relative;}
</style>
</head>
<body>
<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR App</h2>
  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>

  <div class="preview-container">
    <canvas id="previewCanvas"></canvas>
    <div class="close-preview" id="closePreview" style="display:none;">Ã—</div>
  </div>

  <video id="camera" autoplay playsinline></video>
  <button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>

  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result">è¾¨è­˜çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</pre>
  <pre id="ocrPreview">OCR é è¦½</pre>
</div>

<script>
let worker,workerReady=false;
let liveOCRInterval=null;
const status=document.getElementById("status");
const resultPre=document.getElementById("result");
const ocrPreview=document.getElementById("ocrPreview");
const previewCanvas=document.getElementById("previewCanvas");
const closePreview=document.getElementById("closePreview");

// Birthday æ ¼å¼åŒ–
function formatBirthday(str){
    let clean=str.replace(/[^\d]/g,'');
    if(clean.length===6) return '19'+clean.slice(0,2)+'/'+clean.slice(2,4)+'/'+clean.slice(4,6);
    if(clean.length===8) return clean.slice(0,4)+'/'+clean.slice(4,6)+'/'+clean.slice(6,8);
    return str;
}

// ===================== OpenCV + Tesseract åˆå§‹åŒ– =====================
cv['onRuntimeInitialized']=async()=>{
    status.innerText="OpenCV è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ– Tesseractâ€¦";
    worker = Tesseract.createWorker({
        logger:m=>{
            if(m.status==='recognizing text' && m.progress) ocrPreview.innerText=m.text||'';
        }
    });
    await worker.load();
    await worker.loadLanguage('eng+chi_tra+chi_sim');
    await worker.initialize('eng+chi_tra+chi_sim');
    workerReady=true;
    status.innerText="OpenCV + Tesseract åˆå§‹åŒ–å®Œæˆ âœ…";
};

// ===================== Google Sheet =====================
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzUEqAK6KuVQQ1gH05j_plXcq2jIuY5-fiOeseNhjImN-PwppMA_-RGi1ao7x5rQ5yJ/exec";
async function sendToSheet(data){
    if(!data) return;
    try{
        const res=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(data),headers:{'Content-Type':'application/json'}});
        status.innerText=res.ok?"å·²é€å‡ºè‡³ Google Sheet âœ…":"é€å‡ºå¤±æ•— âš ï¸";
    }catch(e){status.innerText="é€å‡ºå¤±æ•— âš ï¸";console.error(e);}
}

// ===================== OCR =====================
async function processCanvas(canvas,previewOnly=false){
    if(!workerReady) {status.innerText="Tesseract åˆå§‹åŒ–å¤±æ•— âŒ";return;}
    const { data: { text } } = await worker.recognize(canvas);
    ocrPreview.innerText=text.trim().slice(0,200);

    let result={raw:text};
    let mrzText=text.replace(/\s/g,'');
    try{
        const mrz=MRZ.parse(mrzText);
        if(mrz.valid){
            result.documentType="Passport";
            result.name=mrz.fields.surname+" "+mrz.fields.givenNames;
            result.id=mrz.fields.documentNumber;
            result.nationality=mrz.fields.nationality;
            result.birthday=formatBirthday(mrz.fields.dateOfBirth);
            result.expiry=formatBirthday(mrz.fields.expirationDate);
            result.sex=mrz.fields.sex;
        } else {
            result.documentType="Taiwan Compatriot Permit";
            let lines=text.split(/\n/).map(l=>l.trim()).filter(l=>l);
            result.name=lines[0]||'';
            result.birthday=formatBirthday(lines[1]||'');
            result.expiry=formatBirthday(lines[2]||'');
        }
    }catch(e){result.documentType="Unknown";}
    resultPre.innerText=JSON.stringify(result,null,2);
    if(!previewOnly) sendToSheet(result);
}

// ===================== ä¸Šå‚³ & ç›¸æ©Ÿ =====================
document.getElementById("fileInput").onchange=e=>{
    if(e.target.files.length>0){
        const file=e.target.files[0];
        const img=new Image();
        img.onload=()=>{
            previewCanvas.width=img.width;
            previewCanvas.height=img.height;
            const ctx=previewCanvas.getContext('2d');
            ctx.drawImage(img,0,0);
            previewCanvas.style.display='block';
            closePreview.style.display='block';
            processCanvas(previewCanvas);
        };
        img.src=URL.createObjectURL(file);
    }
};

closePreview.onclick=()=>{
    previewCanvas.style.display='none';
    closePreview.style.display='none';
    document.getElementById("fileInput").value='';
};

const cameraBtn=document.getElementById("cameraBtn");
const camera=document.getElementById("camera");
const capture=document.getElementById("capture");

// é–‹å•Ÿå³æ™‚è¾¨è­˜
cameraBtn.onclick=async()=>{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    camera.srcObject=stream;
    camera.style.display='block';
    capture.style.display='block';

    if(liveOCRInterval) clearInterval(liveOCRInterval);
    liveOCRInterval=setInterval(async()=>{
        if(!workerReady) return;
        const ctx=previewCanvas.getContext('2d');
        previewCanvas.width=camera.videoWidth;
        previewCanvas.height=camera.videoHeight;
        ctx.drawImage(camera,0,0);
        previewCanvas.style.display='block';
        closePreview.style.display='block';
        await processCanvas(previewCanvas,true); // å³æ™‚é è¦½ï¼Œä¸é€ Google Sheet
    },500);
};

// æ‹ç…§å¾Œåœæ­¢å³æ™‚è¾¨è­˜ï¼Œé€å‡ºçµæœ
capture.onclick=async()=>{
    if(liveOCRInterval) {clearInterval(liveOCRInterval); liveOCRInterval=null;}
    previewCanvas.width=camera.videoWidth;
    previewCanvas.height=camera.videoHeight;
    const ctx=previewCanvas.getContext('2d');
    ctx.drawImage(camera,0,0);
    previewCanvas.style.display='block';
    closePreview.style.display='block';
    await processCanvas(previewCanvas); // é€ Google Sheet
};
</script>
</body>
</html>











