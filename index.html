<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</title>

<!-- Tesseract -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<!-- MRZ Parser -->
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>

<!-- OpenCV -->
<script src="https://docs.opencv.org/4.9.0/opencv.js"></script>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:#f5f6fa;}
.container{width:92%;max-width:500px;margin:28px auto;background:white;border-radius:14px;padding:24px;box-shadow:0 8px 28px rgba(0,0,0,0.1);}
.upload-box{display:flex;gap:12px;margin-bottom:18px;}
button,label{background:#2979ff;color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-size:16px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:.15s;text-align:center;display:inline-block;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
video{width:100%;display:none;border-radius:12px;margin-top:12px;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:220px;overflow-y:auto;margin-top:20px;}
#loaderMask{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:9999;}
.loader{border:6px solid #ddd;border-top:6px solid #2979ff;border-radius:50%;width:60px;height:60px;animation:spin .9s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loader-text{color:white;margin-top:16px;font-size:18px;}
</style>
</head>
<body>

<div id="loaderMask">
  <div>
    <div class="loader"></div>
    <div class="loader-text">æ­£åœ¨è™•ç†ä¸­â€¦</div>
  </div>
</div>

<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</h2>
  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" class="disabled" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn" class="disabled">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>
  <video id="camera" autoplay playsinline></video>
  <button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>
  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result"></pre>
</div>

<script>
// ===============================
// OpenCV åˆå§‹åŒ–
// ===============================
cv['onRuntimeInitialized'] = () => {
    document.getElementById("status").innerText = "OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼";
    document.getElementById("uploadBtn").classList.remove("disabled");
    document.getElementById("cameraBtn").classList.remove("disabled");
};

// ===============================
// å·¥å…·å‡½å¼
// ===============================
function showLoader(){ document.getElementById("loaderMask").style.display="flex"; }
function hideLoader(){ document.getElementById("loaderMask").style.display="none"; }

function imgToMat(blob){
    return new Promise(resolve=>{
        let img=new Image();
        img.onload=()=>{
            let c=document.createElement("canvas");
            c.width=img.width; c.height=img.height;
            c.getContext("2d").drawImage(img,0,0);
            let mat=cv.imread(c);
            resolve(mat);
        };
        img.src=URL.createObjectURL(blob);
    });
}

// ===============================
// è‡ªå‹•æ—‹è½‰æ ¡æ­£
// ===============================
function autoRotate(src){
    let gray=new cv.Mat();
    cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
    let edges=new cv.Mat();
    cv.Canny(gray,edges,50,200);
    let lines=new cv.Mat();
    cv.HoughLinesP(edges,lines,1,Math.PI/180,80,100,10);
    if(lines.rows===0){ gray.delete(); edges.delete(); lines.delete(); return src;}
    let angles=[];
    for(let i=0;i<lines.rows;i++){
        let p=lines.intPtr(i); angles.push(Math.atan2(p[3]-p[1],p[2]-p[0])*180/Math.PI);}
    let avgAngle=angles.reduce((a,b)=>a+b,0)/angles.length;
    if(Math.abs(avgAngle)<1){ gray.delete(); edges.delete(); lines.delete(); return src;}
    let center=new cv.Point(src.cols/2,src.rows/2);
    let rotMat=cv.getRotationMatrix2D(center,avgAngle,1);
    let dst=new cv.Mat();
    cv.warpAffine(src,dst,rotMat,new cv.Size(src.cols,src.rows),cv.INTER_LINEAR,cv.BORDER_REPLICATE);
    gray.delete(); edges.delete(); lines.delete(); rotMat.delete(); src.delete();
    return dst;
}

// ===============================
// å½±åƒå¢å¼·
// ===============================
function enhanceImage(src){
    let gray=new cv.Mat();
    cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
    let clahe=new cv.CLAHE(3.0,new cv.Size(8,8)); clahe.apply(gray,gray);
    let blur=new cv.Mat(); cv.GaussianBlur(gray,blur,new cv.Size(0,0),3);
    cv.addWeighted(gray,1.7,blur,-0.7,0,gray);
    blur.delete(); src.delete();
    return gray;
}

// ===============================
// MRZ åµæ¸¬
// ===============================
function detectMRZ(gray){
    let sobel=new cv.Mat();
    cv.Sobel(gray,sobel,cv.CV_8U,1,0,3);
    let binary=new cv.Mat();
    cv.threshold(sobel,binary,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);
    let kernel=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(25,5));
    cv.morphologyEx(binary,binary,cv.MORPH_CLOSE,kernel);
    let contours=new cv.MatVector();
    let hierarchy=new cv.Mat();
    cv.findContours(binary,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
    let mrzRect=null,maxWidth=0;
    for(let i=0;i<contours.size();i++){
        let cnt=contours.get(i);
        let rect=cv.boundingRect(cnt);
        if(rect.width>maxWidth && rect.height>gray.rows*0.03 && rect.y>gray.rows*0.55){
            maxWidth=rect.width; mrzRect=rect;
        }
        cnt.delete();
    }
    contours.delete(); hierarchy.delete(); sobel.delete(); binary.delete();
    if(!mrzRect) return null;
    let mrz=gray.roi(new cv.Rect(mrzRect.x,mrzRect.y,mrzRect.width,mrzRect.height));
    return mrz;
}

// ===============================
// MRZ OCR
// ===============================
async function ocrMRZ(mrzMat){
    let c=document.createElement("canvas");
    c.width=mrzMat.cols; c.height=mrzMat.rows;
    cv.imshow(c,mrzMat);
    let blob=await new Promise(r=>c.toBlob(r,"image/png"));

    async function tryOCR(blob){
        const {data:{text}}=await Tesseract.recognize(blob,{
            lang:"ocrb",
            tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<"
        });
        let clean=text.replace(/\s+/g,'');
        try{
            let parsed=MRZ.parse(clean);
            if(parsed.valid){ return {
                documentType:"Passport",
                name:parsed.fields.surname+" "+parsed.fields.givenNames,
                id:parsed.fields.documentNumber,
                nationality:parsed.fields.nationality,
                birthday:parsed.fields.dateOfBirth,
                expiry:parsed.fields.expirationDate,
                sex:parsed.fields.sex,
                raw:clean
            }; }
        }catch(e){ return null;}
        return null;
    }

    let res=await tryOCR(blob);
    if(res) return res;

    // å˜—è©¦æ—‹è½‰ 180Â° OCR
    let c2=document.createElement("canvas");
    c2.width=c.width; c2.height=c.height;
    let ctx=c2.getContext("2d");
    ctx.translate(c2.width/2,c2.height/2); ctx.rotate(Math.PI); ctx.drawImage(c,-c.width/2,-c.height/2);
    let blob2=await new Promise(r=>c2.toBlob(r,"image/png"));
    return await tryOCR(blob2);
}

// ===============================
// å°èƒè­‰ OCR
// ===============================
async function ocrTaiwanPermit(src){
    let gray=new cv.Mat();
    cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
    cv.threshold(gray,gray,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);

    let nameROI=gray.roi(new cv.Rect(150,60,gray.cols-160,60));
    let birthROI=gray.roi(new cv.Rect(150,130,300,50));
    let expROI=gray.roi(new cv.Rect(500,130,250,50));

    async function roiToText(roi){
        let c=document.createElement("canvas"); c.width=roi.cols; c.height=roi.rows;
        cv.imshow(c,roi);
        let blob=await new Promise(r=>c.toBlob(r,"image/png"));
        let {data:{text}}=await Tesseract.recognize(blob,{lang:"eng+chi_tra"});
        return text.trim();
    }

    let name=await roiToText(nameROI);
    let birthday=await roiToText(birthROI);
    let expiry=await roiToText(expROI);

    nameROI.delete(); birthROI.delete(); expROI.delete(); gray.delete();

    return {documentType:"Taiwan Compatriot Permit",name,birthday,expiry};
}

// ===============================
// ä¸»æµç¨‹
// ===============================
const SCRIPT_URL="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // <-- æ”¹æˆä½ çš„ GAS URL

async function processImage(file){
    showLoader();
    status.innerText="è®€å–å½±åƒä¸­â€¦";

    let src=await imgToMat(file);
    status.innerText="è‡ªå‹•æ—‹è½‰æ ¡æ­£â€¦"; src=autoRotate(src);
    status.innerText="å½±åƒå¢å¼·â€¦"; let enhanced=enhanceImage(src);
    status.innerText="åµæ¸¬ MRZâ€¦"; let mrzMat=detectMRZ(enhanced);

    let data=null;
    if(mrzMat){ status.innerText="è¾¨è­˜è­·ç…§ MRZâ€¦"; data=await ocrMRZ(mrzMat); mrzMat.delete(); }
    if(!data){ status.innerText="è¾¨è­˜å°èƒè­‰â€¦"; data=await ocrTaiwanPermit(src); }

    src.delete(); enhanced.delete();
    result.innerText=JSON.stringify(data,null,2);

    // å¯«å…¥ Google Sheet
    status.innerText="å¯«å…¥ Google Sheetâ€¦";
    await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(data)});
    status.innerText="ğŸ‰ å·²å¯«å…¥ Google Sheetï¼";
    hideLoader();
}

// ===============================
// ä¸Šå‚³åœ–ç‰‡
// ===============================
document.getElementById("fileInput").onchange=e=>{
    if(e.target.files.length>0) processImage(e.target.files[0]);
};

// ===============================
// ç›¸æ©Ÿæ‹ç…§
// ===============================
const cameraBtn=document.getElementById("cameraBtn");
const camera=document.getElementById("camera");
const capture=document.getElementById("capture");

cameraBtn.onclick=async()=>{
    if(cameraBtn.classList.contains("disabled")) return;
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    camera.srcObject=stream; camera.style.display="block"; capture.style.display="block";
};

capture.onclick=()=>{
    const c=document.createElement("canvas"); c.width=camera.videoWidth; c.height=camera.videoHeight;
    c.getContext("2d").drawImage(camera,0,0); c.toBlob(blob=>processImage(blob));
};
</script>
</body>
</html>








