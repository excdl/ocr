<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<script src="https://docs.opencv.org/4.9.0/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background: linear-gradient(135deg,#6a11cb,#2575fc);}
.container{width:95%;max-width:500px;margin:20px auto;background:#fff;border-radius:20px;padding:20px;box-shadow:0 8px 28px rgba(0,0,0,0.2);animation:fadeIn 0.6s ease-out;}
h2{text-align:center;margin-bottom:20px;color:#333;}
.upload-box{display:flex;gap:12px;margin-bottom:18px;}
button,label{background:#2979ff;color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-size:16px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:.2s;text-align:center;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
video{width:100%;display:none;border-radius:12px;margin-top:12px;}
canvas#ocrCanvas{width:100%;border-radius:12px;margin-top:12px;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:150px;overflow-y:auto;margin-top:12px;white-space:pre-wrap;}
#qrCode{text-align:center;margin-top:12px;}
@keyframes fadeIn{from{opacity:0; transform:translateY(20px);}to{opacity:1; transform:translateY(0);}}
</style>
</head>
<body>
<div class="container">
<h2>è­·ç…§ / å°èƒè­‰ OCR App</h2>
<div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" class="disabled" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn" class="disabled">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
</div>
<video id="camera" autoplay playsinline></video>
<button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>
<canvas id="ocrCanvas"></canvas>
<p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
<pre id="ocrPreview">å³æ™‚ OCR é è¦½å€</pre>
<pre id="result"></pre>
<div id="qrCode"></div>
</div>

<script>
// ===== æ—¥æœŸè™•ç† =====
function normalizeDigits(str){if(!str)return"";return str.replace(/O/g,"0").replace(/o/g,"0").replace(/I/g,"1").replace(/l/g,"1").replace(/S/g,"5").replace(/B/g,"8").replace(/\D/g,"");}
function isValidDate(y,m,d){let dt=new Date(y,m-1,d);return dt.getFullYear()===y&&dt.getMonth()===m-1&&dt.getDate()===d;}
function fixDate(raw){raw=normalizeDigits(raw);if(raw.length<6)return raw;let yyyy,mm,dd;if(raw.length>=8){yyyy=parseInt(raw.slice(0,4));mm=parseInt(raw.slice(4,6));dd=parseInt(raw.slice(6,8));}else{let yy=parseInt(raw.slice(0,2));mm=parseInt(raw.slice(2,4));dd=parseInt(raw.slice(4,6));yyyy=yy>=30?1900+yy:2000+yy;}if(!isValidDate(yyyy,mm,dd)){mm=Math.min(Math.max(mm,1),12);dd=Math.min(Math.max(dd,1),28);}const today=new Date();let guess=new Date(yyyy,mm-1,dd);if(guess>today) yyyy-=100;if(today.getFullYear()-yyyy>120) yyyy+=100;return`${yyyy}/${String(mm).padStart(2,"0")}/${String(dd).padStart(2,"0")}`;}
function calculateAge(dateStr){if(!dateStr||dateStr.length<10)return"";const [y,m,d]=dateStr.split("/").map(n=>parseInt(n));const today=new Date();let age=today.getFullYear()-y;if(today.getMonth()+1<m||(today.getMonth()+1===m&&today.getDate()<d)) age--;return age;}
function calculateDaysLeft(dateStr){if(!dateStr||dateStr.length<10)return"";const [y,m,d]=dateStr.split("/").map(n=>parseInt(n));const expiry=new Date(y,m-1,d);const today=new Date();return Math.ceil((expiry-today)/1000/60/60/24);}
function isExpired(dateStr){if(!dateStr||dateStr.length<10)return true;const [y,m,d]=dateStr.split("/").map(n=>parseInt(n));return new Date(y,m-1,d)<new Date();}

// ===== OpenCV & Tesseract =====
let worker,workerReady=false;
cv['onRuntimeInitialized']=async()=>{
    document.getElementById("status").innerText="OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼";
    document.getElementById("uploadBtn").classList.remove("disabled");
    document.getElementById("cameraBtn").classList.remove("disabled");
    worker=Tesseract.createWorker({
        logger:m=>{
            if(m.status==='recognizing text' && m.progress){
                document.getElementById("ocrPreview").innerText=m.text||'';
            }
        }
    });
    await worker.load(); await worker.loadLanguage('eng+chi_tra'); await worker.initialize('eng+chi_tra'); workerReady=true;
    document.getElementById("status").innerText+=" | Tesseract å·²åˆå§‹åŒ–";
};

// ===== åœ–åƒè™•ç† =====
function imgToMat(blob){return new Promise(resolve=>{let img=new Image();img.onload=()=>{let c=document.createElement("canvas");c.width=img.width;c.height=img.height;c.getContext("2d").drawImage(img,0,0);resolve(cv.imread(c));};img.src=URL.createObjectURL(blob);});}
function enhanceMat(mat){let gray=new cv.Mat();cv.cvtColor(mat,gray,cv.COLOR_RGBA2GRAY);cv.GaussianBlur(gray,gray,new cv.Size(3,3),0);cv.adaptiveThreshold(gray,gray,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY,31,15);return gray;}
function isBlur(mat){let lap=new cv.Mat();cv.Laplacian(mat,lap,cv.CV_64F);let mean=cv.meanStdDev(lap);lap.delete();return mean[1][0]<20;}

// ===== å³æ™‚ OCR é è¦½ =====
let videoStream, animationFrame;
const canvas=document.getElementById("ocrCanvas");
const ctx=canvas.getContext("2d");
const camera=document.getElementById("camera");
async function livePreview(){
    if(!videoStream) return;
    canvas.width=camera.videoWidth; canvas.height=camera.videoHeight;
    ctx.drawImage(camera,0,0,canvas.width,canvas.height);
    let mat=cv.imread(canvas); let gray=enhanceMat(mat);

    // ç•« OCR å€åŸŸ
    ctx.lineWidth=3; ctx.strokeStyle='rgba(255,0,0,0.6)';
    [[0.05,0.10,0.90,0.12],[0.05,0.25,0.55,0.08],[0.65,0.25,0.30,0.08]].forEach(r=>ctx.strokeRect(r[0]*gray.cols,r[1]*gray.rows,r[2]*gray.cols,r[3]*gray.rows));
    ctx.strokeStyle='rgba(0,0,255,0.6)';
    let mrzY=Math.floor(gray.rows*0.75), mrzH=gray.rows-mrzY; ctx.strokeRect(0,mrzY,gray.cols,mrzH);

    // å³æ™‚ OCR
    if(workerReady){
        let tempCanvas=document.createElement("canvas"); tempCanvas.width=gray.cols; tempCanvas.height=gray.rows;
        cv.imshow(tempCanvas,gray);
        tempCanvas.toBlob(async blob=>{
            const {data:{text}}=await worker.recognize(blob);
            document.getElementById("ocrPreview").innerText=text.trim();
        });
    }

    gray.delete(); mat.delete();
    animationFrame=requestAnimationFrame(livePreview);
}

// ===== QR Code ç”Ÿæˆ =====
function generateQRCode(data){let qrDiv=document.getElementById("qrCode");qrDiv.innerHTML="";let qrText=`å§“å:${data.name||data.cname||''}\nç”Ÿæ—¥:${data.birthday}\næœ‰æ•ˆæœŸ:${data.expiry}`;QRCode.toCanvas(qrText,{width:180},function(err,canvas){if(!err)qrDiv.appendChild(canvas);});}

// ===== ä¸Šå‚³ & ç›¸æ©Ÿ =====
document.getElementById("fileInput").onchange=e=>{if(e.target.files.length>0)processImage(e.target.files[0]);};
const cameraBtn=document.getElementById("cameraBtn");const capture=document.getElementById("capture");
cameraBtn.onclick=async()=>{
    if(cameraBtn.classList.contains("disabled"))return;
    videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    camera.srcObject=videoStream; camera.style.display="block"; capture.style.display="block";
    livePreview();
};
capture.onclick=()=>{const c=document.createElement("canvas");c.width=camera.videoWidth;c.height=camera.videoHeight;c.getContext("2d").drawImage(camera,0,0);c.toBlob(blob=>processImage(blob));};

// ===== ä¸»æµç¨‹ =====
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzUEqAK6KuVQQ1gH05j_plXcq2jIuY5-fiOeseNhjImN-PwppMA_-RGi1ao7x5rQ5yJ/exec";

async function ocrProcess(mat){
    if(!workerReady) await worker.load();
    let gray=enhanceMat(mat);
    let result=null;
    let isPassport=false;

    // è­·ç…§ MRZ
    let mrzY=Math.floor(gray.rows*0.75), mrzH=gray.rows-mrzY;
    let mrzROI=gray.roi(new cv.Rect(0,mrzY,gray.cols,mrzH));
    let tempCanvas=document.createElement("canvas");
    cv.imshow(tempCanvas,mrzROI);
    let blob=await new Promise(r=>tempCanvas.toBlob(r,"image/png"));
    try{
        const {data:{text}}=await worker.recognize(blob,{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'});let clean=text.replace(/[^A-Z0-9<]/g,'');
        let parsed=MRZ.parse(clean); if(parsed.valid){
            isPassport=true; result={type:"Passport",name:parsed.fields.surname+" "+parsed.fields.givenNames,id:parsed.fields.documentNumber,nationality:parsed.fields.nationality,birthday:fixDate(parsed.fields.dateOfBirth),expiry:fixDate(parsed.fields.expirationDate),age:calculateAge(fixDate(parsed.fields.dateOfBirth)),daysLeft:calculateDaysLeft(fixDate(parsed.fields.expirationDate)),expired:isExpired(fixDate(parsed.fields.expirationDate)),sex:parsed.fields.sex,raw:clean};
        }
    }catch(e){result=null;}
    mrzROI.delete();

    // å°èƒè­‰
    if(!isPassport){
        function roi(r){return gray.roi(new cv.Rect(Math.floor(r.x*gray.cols),Math.floor(r.y*gray.rows),Math.floor(r.w*gray.cols),Math.floor(r.h*gray.rows)));}
        const nameROI=roi({x:0.05,y:0.10,w:0.90,h:0.12});
        const birthROI=roi({x:0.05,y:0.25,w:0.55,h:0.08});
        const expROI=roi({x:0.65,y:0.25,w:0.30,h:0.08});
        async function roiToText(r){let c=document.createElement("canvas");c.width=r.cols;c.height=r.rows;cv.imshow(c,r);let blob=await new Promise(r=>c.toBlob(r,"image/png"));const {data:{text}}=await worker.recognize(blob);return text.trim();}
        let name=await roiToText(nameROI), birthday=fixDate(await roiToText(birthROI)), expiry=fixDate(await roiToText(expROI));
        nameROI.delete(); birthROI.delete(); expROI.delete();
        result={type:"Taiwan Compatriot Permit",name,birthday,expiry,age:calculateAge(birthday),daysLeft:calculateDaysLeft(expiry),expired:isExpired(expiry)};
    }

    gray.delete(); return result;
}

async function processImage(file){
    document.getElementById("ocrPreview").innerText="OCR è™•ç†ä¸­â€¦";
    let mat=await imgToMat(file);
    if(isBlur(mat)) alert("ç•«é¢å¯èƒ½æ¨¡ç³Šï¼Œå»ºè­°é‡æ‹ï¼");
    let data=await ocrProcess(mat);
    mat.delete();
    if(data){
        document.getElementById("result").innerText=JSON.stringify(data,null,2);
        generateQRCode(data);
        try{await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(data)});}catch(e){console.warn("å¯«å…¥ Google Sheet å¤±æ•—:", e);}
    }else document.getElementById("result").innerText="è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡æ‹";
}
</script>
</body>
</html>













