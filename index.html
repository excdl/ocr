<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:#f5f6fa;}
.container{width:92%;max-width:500px;margin:28px auto;background:white;border-radius:14px;padding:24px;box-shadow:0 8px 28px rgba(0,0,0,0.1);}
button,label{background:#2979ff;color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-size:16px;width:48%;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:.15s;text-align:center;display:inline-block;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
button:active,label:active{transform:scale(0.96);}
.upload-box{display:flex;justify-content:space-between;margin-bottom:18px;}
video{width:100%;display:none;border-radius:12px;margin-top:12px;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:220px;overflow-y:auto;margin-top:20px;}
#loaderMask{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:9999;}
.loader{border:6px solid #ddd;border-top:6px solid #2979ff;border-radius:50%;width:60px;height:60px;animation:spin .9s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loader-text{color:white;margin-top:16px;font-size:18px;}
</style>
</head>
<body>

<div id="loaderMask">
  <div>
    <div class="loader"></div>
    <div class="loader-text">æ­£åœ¨è™•ç†ä¸­â€¦</div>
  </div>
</div>

<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</h2>
  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <label id="uploadBtn" class="disabled" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
    <button id="cameraBtn" class="disabled">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>
  <video id="camera" autoplay playsinline></video>
  <button id="capture" style="display:none;width:100%;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>
  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result"></pre>
</div>

<script>
/* -------------------- OpenCV è¼‰å…¥æª¢æ¸¬ -------------------- */
let openCVReady=false, openCVRetries=0, MAX_RETRIES=5;
const status=document.getElementById("status");
function onOpenCvReady(){ openCVReady=true; status.innerText="OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼"; document.getElementById("uploadBtn").classList.remove("disabled"); document.getElementById("cameraBtn").classList.remove("disabled"); }
function checkOpenCV(){
    if(window.cv && cv.Mat){ onOpenCvReady(); }
    else{ 
        openCVRetries++;
        if(openCVRetries<=MAX_RETRIES){ status.innerText=`æ­£åœ¨è¼‰å…¥ OpenCVâ€¦ (${openCVRetries}/${MAX_RETRIES})`; setTimeout(checkOpenCV,1000); }
        else{ status.innerText="âš  OpenCV è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡æ–°æ•´ç†é é¢ã€‚"}
    }
}
checkOpenCV();

/* -------------------- Google Sheet URL -------------------- */
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzvKoYxbt5ha-o86IIs8GbmzVtviw_xqdP6O-zhg7BycRoBWZq7vQyKi3YqRb9Nasqb/exec"; // <-- æ”¹æˆä½ çš„ GAS Web App URL
const loaderMask=document.getElementById("loaderMask");
const result=document.getElementById("result");
function showLoader(){loaderMask.style.display="flex";}
function hideLoader(){loaderMask.style.display="none";}

/* -------------------- MRZ å‰è™•ç† + OCR -------------------- */
async function preprocessMRZ(blob){
    return new Promise(resolve=>{
        const img=new Image();
        img.onload=()=>{
            const c=document.createElement("canvas");
            c.width=img.width;c.height=img.height;
            const ctx=c.getContext("2d"); ctx.drawImage(img,0,0);
            let src=cv.imread(c);
            cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(src, src, new cv.Size(3,3),0);
            cv.adaptiveThreshold(src, src, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY,31,15);
            const mrzY=Math.floor(src.rows*0.75), mrzH=src.rows-mrzY;
            let mrzMat=src.roi(new cv.Rect(0,mrzY,src.cols,mrzH));
            cv.imshow(c, mrzMat);
            mrzMat.delete(); src.delete();
            c.toBlob(resolve,"image/jpeg");
        };
        img.src=URL.createObjectURL(blob);
    });
}

async function recognizeMRZEnhanced(blob){
    const {data:{text}}=await Tesseract.recognize(blob,{lang:'eng',tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<'});
    try{ const parsed=MRZ.parse(text.replace(/\s/g,'')); return parsed.valid?parsed:null; }catch(e){ return null; }
}

/* -------------------- å°èƒè­‰æ¨¡æ¿ OCR -------------------- */
async function recognizeTaiwanPermit(blob){
    return new Promise(resolve=>{
        const img=new Image();
        img.onload=async ()=>{
            const c=document.createElement("canvas"); c.width=img.width;c.height=img.height;
            const ctx=c.getContext("2d"); ctx.drawImage(img,0,0);
            let src=cv.imread(c);
            cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(src, src, new cv.Size(3,3),0);
            cv.adaptiveThreshold(src, src, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY,31,15);

            const nameROI=src.roi(new cv.Rect(150,60,src.cols-160,60));
            const birthdayROI=src.roi(new cv.Rect(150,120,300,40));
            const expiryROI=src.roi(new cv.Rect(500,120,200,40));

            let canvasName=document.createElement("canvas"); cv.imshow(canvasName,nameROI);
            let nameBlob=await new Promise(r=>canvasName.toBlob(r,"image/jpeg"));
            let canvasBirthday=document.createElement("canvas"); cv.imshow(canvasBirthday,birthdayROI);
            let birthdayBlob=await new Promise(r=>canvasBirthday.toBlob(r,"image/jpeg"));
            let canvasExpiry=document.createElement("canvas"); cv.imshow(canvasExpiry,expiryROI);
            let expiryBlob=await new Promise(r=>canvasExpiry.toBlob(r,"image/jpeg"));

            nameROI.delete(); birthdayROI.delete(); expiryROI.delete(); src.delete();

            const worker=await Tesseract.createWorker();
            await worker.loadLanguage('eng+chi_tra'); await worker.initialize('eng+chi_tra');

            const {data:{text:nameText}}=await worker.recognize(nameBlob);
            const {data:{text:birthdayText}}=await worker.recognize(birthdayBlob);
            const {data:{text:expiryText}}=await worker.recognize(expiryBlob);

            await worker.terminate();
            resolve({name:nameText.trim(),birthday:birthdayText.trim(),expiry:expiryText.trim()});
        };
        img.src=URL.createObjectURL(blob);
    });
}

/* -------------------- ä¸»æµç¨‹ -------------------- */
async function processImage(file){
    showLoader(); status.innerText="å½±åƒè™•ç†ä¸­â€¦";
    const processed=await preprocessMRZ(file);
    status.innerText="è­·ç…§ MRZ è¾¨è­˜ä¸­â€¦";
    let mrz=await recognizeMRZEnhanced(processed);
    let data={};
    if(mrz){
        status.innerText="âœ“ è­·ç…§è¾¨è­˜æˆåŠŸ";
        data={documentType:"Passport",name:mrz.fields.surname+" "+mrz.fields.givenNames,id:mrz.fields.documentNumber,nationality:mrz.fields.nationality,birthday:mrz.fields.dateOfBirth,expiry:mrz.fields.expirationDate,sex:mrz.fields.sex};
        result.innerText=JSON.stringify(data,null,2);
    }else{
        status.innerText="å°èƒè­‰ OCR è¾¨è­˜ä¸­â€¦";
        data=await recognizeTaiwanPermit(file); data.documentType="Taiwan Compatriot Permit";
        result.innerText=JSON.stringify(data,null,2);
    }
    status.innerText="å¯«å…¥ Google Sheetâ€¦";
    await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(data)});
    status.innerText="ğŸ‰ å·²å¯«å…¥ Google Sheetï¼";
    hideLoader();
}

/* -------------------- ä¸Šå‚³ & ç›¸æ©Ÿ -------------------- */
document.getElementById("fileInput").onchange=e=>{if(e.target.files.length>0)processImage(e.target.files[0]);};

const cameraBtn=document.getElementById("cameraBtn"), camera=document.getElementById("camera"), capture=document.getElementById("capture");
cameraBtn.onclick=async()=>{
    if(cameraBtn.classList.contains("disabled")) return;
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    camera.srcObject=stream; camera.style.display="block"; capture.style.display="block";
};
capture.onclick=()=>{
    const c=document.createElement("canvas"); c.width=camera.videoWidth;c.height=camera.videoHeight;
    c.getContext("2d").drawImage(camera,0,0); c.toBlob(blob=>processImage(blob));
};
</script>

</body>
</html>






