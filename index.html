<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR App</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.3.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mrz/dist/mrz.min.js"></script>
<script src="https://docs.opencv.org/4.9.0/opencv.js"></script>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:linear-gradient(135deg,#4facfe,#00f2fe);}
.container{width:92%;max-width:800px;margin:28px auto;background:white;border-radius:18px;padding:24px;box-shadow:0 12px 28px rgba(0,0,0,0.15);animation:fadeIn 0.6s;}
@keyframes fadeIn{from {opacity:0;transform:translateY(-20px);} to {opacity:1;transform:translateY(0);}}
h2{margin-top:0;text-align:center;color:#333;}
.upload-box{display:flex;gap:10px;margin-bottom:12px;}
button,label{background:#2979ff;color:white;border:none;padding:12px 18px;border-radius:12px;cursor:pointer;font-size:16px;flex:1;text-align:center;transition:.2s;}
button:disabled,label.disabled{opacity:0.5;cursor:not-allowed;}
.preview-container{display:flex;gap:12px; margin-top:12px;}
canvas{border-radius:12px; width:48%; height:auto; background:#eee;}
#ocrPreview,pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:150px;overflow-y:auto;margin-top:12px;font-family:monospace;}
.close-preview{position:absolute;top:8px;right:8px;background:red;color:white;padding:2px 6px;border-radius:6px;cursor:pointer;font-size:14px;}
</style>
</head>
<body>
<div class="container">
<h2>è­·ç…§ / å°èƒè­‰ OCR App</h2>
<div class="upload-box">
<input type="file" id="fileInput" accept="image/*" hidden>
<label id="uploadBtn" for="fileInput">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</label>
<button id="cameraBtn">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
</div>

<div class="preview-container">
<canvas id="fullCanvas"></canvas>
<canvas id="mrzCanvas"></canvas>
</div>

<video id="camera" autoplay playsinline style="display:none;"></video>
<button id="capture" style="display:none;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>

<p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
<pre id="result">è¾¨è­˜çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</pre>
<pre id="ocrPreview">OCR é è¦½</pre>
</div>

<script>
let worker, workerReady=false;
let liveOCRInterval=null;
const status=document.getElementById("status");
const resultPre=document.getElementById("result");
const ocrPreview=document.getElementById("ocrPreview");
const fullCanvas=document.getElementById("fullCanvas");
const mrzCanvasElement=document.getElementById("mrzCanvas");

// æ ¼å¼åŒ–ç”Ÿæ—¥
function formatBirthday(str){
    let clean=str.replace(/[^\d]/g,'');
    if(clean.length===6) return '19'+clean.slice(0,2)+'/'+clean.slice(2,4)+'/'+clean.slice(4,6);
    if(clean.length===8) return clean.slice(0,4)+'/'+clean.slice(4,6)+'/'+clean.slice(6,8);
    return str;
}

// ===================== Tesseract åˆå§‹åŒ– =====================
function initTesseract(){
    try{
        worker=Tesseract.createWorker({logger:m=>{ if(m.status==='recognizing text' && m.progress) ocrPreview.innerText=m.text||''; }});
        (async ()=>{
            await worker.load();
            await worker.loadLanguage('eng+chi_tra+chi_sim');
            await worker.initialize('eng+chi_tra+chi_sim');
            workerReady=true;
            status.innerText="OpenCV + Tesseract åˆå§‹åŒ–å®Œæˆ âœ…";
        })();
    }catch(e){ console.error("Tesseract åˆå§‹åŒ–å¤±æ•—:",e); status.innerText="Tesseract åˆå§‹åŒ–å¤±æ•— âŒ"; }
}

if(typeof cv==='undefined'){
    status.innerText="OpenCV è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç‰ˆæœ¬";
}else{
    cv['onRuntimeInitialized']=()=>{ status.innerText="OpenCV è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ– Tesseractâ€¦"; initTesseract(); };
}

// ===================== Google Sheet =====================
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzUEqAK6KuVQQ1gH05j_plXcq2jIuY5-fiOeseNhjImN-PwppMA_-RGi1ao7x5rQ5yJ/exec";
async function sendToSheet(data){
    if(!data) return;
    try{
        const res=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify(data),headers:{'Content-Type':'application/json'}});
        status.innerText=res.ok?"å·²é€å‡ºè‡³ Google Sheet âœ…":"é€å‡ºå¤±æ•— âš ï¸";
    }catch(e){ status.innerText="é€å‡ºå¤±æ•— âš ï¸"; console.error(e); }
}

// ===================== MRZ æå– =====================
function extractMRZRegion(canvas){
    try{
        let src = cv.imread(canvas);
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

        let clahe = new cv.CLAHE(2.0, new cv.Size(8,8));
        let enhanced = new cv.Mat();
        clahe.apply(gray, enhanced);

        let gamma = 1.2;
        let lookUpTable = new cv.Mat(1, 256, cv.CV_8U);
        for(let i=0;i<256;i++){ lookUpTable.ucharPtr(0,i)[0] = Math.min(255, Math.pow(i/255.0, 1/gamma)*255); }
        let gammaCorrected = new cv.Mat();
        cv.LUT(enhanced, lookUpTable, gammaCorrected);

        const blur = new cv.Mat();
        cv.GaussianBlur(gammaCorrected, blur, new cv.Size(3,3), 0);
        const thresh = new cv.Mat();
        cv.threshold(blur, thresh, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

        const contours = new cv.MatVector();
        const hierarchy = new cv.Mat();
        cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let mrzRect = null;
        let mrzContour = null;
        for(let i=0;i<contours.size();i++){
            let cnt=contours.get(i);
            let rect = cv.boundingRect(cnt);
            if(rect.width > rect.height*5 && rect.y > src.rows*0.5){
                if(!mrzRect || rect.y > mrzRect.y){
                    mrzRect = rect;
                    mrzContour = cnt;
                } else { cnt.delete(); }
            } else { cnt.delete(); }
        }

        if(mrzRect && mrzContour){
            const rotatedRect = cv.minAreaRect(mrzContour);
            let angle = rotatedRect.angle;
            if(rotatedRect.size.width < rotatedRect.size.height) angle += 90;

            const center = new cv.Point(src.cols/2, src.rows/2);
            const M = cv.getRotationMatrix2D(center, angle, 1);
            const rotated = new cv.Mat();
            cv.warpAffine(src, rotated, M, new cv.Size(src.cols, src.rows), cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());

            const mrzCanvas = document.createElement('canvas');
            mrzCanvas.width = mrzRect.width;
            mrzCanvas.height = mrzRect.height;
            const ctx = mrzCanvas.getContext('2d');
            ctx.drawImage(rotated, mrzRect.x, mrzRect.y, mrzRect.width, mrzRect.height, 0, 0, mrzRect.width, mrzRect.height);

            // æ¸…ç†
            src.delete(); gray.delete(); enhanced.delete(); gammaCorrected.delete();
            blur.delete(); thresh.delete(); contours.delete(); hierarchy.delete(); rotated.delete(); clahe.delete(); lookUpTable.delete();
            return mrzCanvas;
        } else {
            src.delete(); gray.delete(); enhanced.delete(); gammaCorrected.delete();
            blur.delete(); thresh.delete(); contours.delete(); hierarchy.delete(); clahe.delete(); lookUpTable.delete();
            return canvas;
        }
    }catch(e){ console.error("MRZ è‡ªå‹•æ—‹è½‰è£åˆ‡å¤±æ•—:", e); return canvas; }
}

// ===================== OCR =====================
async function processCanvas(canvas,previewOnly=false){
    if(!workerReady){ status.innerText="Tesseract åˆå§‹åŒ–å¤±æ•— âŒ"; return; }

    // æ›´æ–°æ•´å¼µåœ–ç‰‡
    fullCanvas.width = canvas.width;
    fullCanvas.height = canvas.height;
    const ctxFull = fullCanvas.getContext('2d');
    ctxFull.drawImage(canvas,0,0);

    // æ›´æ–° MRZ
    const mrzCanvas = extractMRZRegion(canvas);
    mrzCanvasElement.width = mrzCanvas.width;
    mrzCanvasElement.height = mrzCanvas.height;
    const ctxMRZ = mrzCanvasElement.getContext('2d');
    ctxMRZ.drawImage(mrzCanvas,0,0);

    try{
        const { data:{ text } } = await worker.recognize(mrzCanvas);
        ocrPreview.innerText=text.trim().slice(0,300);

        let result={raw:text};
        let mrzText=text.replace(/\s/g,'');
        try{
            const mrz=MRZ.parse(mrzText);
            if(mrz.valid){
                result.documentType="Passport";
                result.name=mrz.fields.surname+" "+mrz.fields.givenNames;
                result.id=mrz.fields.documentNumber;
                result.nationality=mrz.fields.nationality;
                result.birthday=formatBirthday(mrz.fields.dateOfBirth);
                result.expiry=formatBirthday(mrz.fields.expirationDate);
                result.sex=mrz.fields.sex;
            }else{
                result.documentType="Taiwan Compatriot Permit";
                let lines=text.split(/\n/).map(l=>l.trim()).filter(l=>l);
                result.name=lines[0]||'';
                result.birthday=formatBirthday(lines[1]||'');
                result.expiry=formatBirthday(lines[2]||'');
            }
        }catch(e){ result.documentType="Unknown"; }
        resultPre.innerText=JSON.stringify(result,null,2);
        if(!previewOnly) sendToSheet(result);
    }catch(e){ console.error("OCR å¤±æ•—:",e); status.innerText="OCR å¤±æ•— âŒ"; }
}

// ===================== ä¸Šå‚³ & ç›¸æ©Ÿ =====================
document.getElementById("fileInput").onchange=e=>{
    if(e.target.files.length>0){
        const file=e.target.files[0];
        const img=new Image();
        img.onload=()=>{
            processCanvas(img);
        };
        img.src=URL.createObjectURL(file);
    }
};

const cameraBtn=document.getElementById("cameraBtn");
const camera=document.getElementById("camera");
const capture=document.getElementById("capture");

cameraBtn.onclick=async()=>{
    try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        camera.srcObject=stream;
        camera.style.display='block';
        capture.style.display='block';
        if(liveOCRInterval) clearInterval(liveOCRInterval);
        liveOCRInterval=setInterval(async()=>{
            if(!workerReady) return;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = camera.videoWidth;
            tempCanvas.height = camera.videoHeight;
            const ctx=tempCanvas.getContext('2d');
            ctx.drawImage(camera,0,0);
            await processCanvas(tempCanvas,true);
        },500);
    }catch(e){ console.error("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ:",e); status.innerText="ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ âŒ"; }
};

capture.onclick=async()=>{
    if(liveOCRInterval){ clearInterval(liveOCRInterval); liveOCRInterval=null; }
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = camera.videoWidth;
    tempCanvas.height = camera.videoHeight;
    const ctx=tempCanvas.getContext('2d');
    ctx.drawImage(camera,0,0);
    await processCanvas(tempCanvas);
};
</script>
</body>
</html>










