<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR MRZ</title>
<style>
body{font-family:Arial, sans-serif;background:#f0f0f0;padding:20px;}
.container{max-width:480px;margin:auto;background:white;padding:20px;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.1);}
button,input{padding:10px 14px;margin:5px 0;border-radius:8px;border:1px solid #ccc;cursor:pointer;}
canvas{display:none;}
pre{background:#222;color:#0f0;padding:10px;border-radius:8px;overflow:auto;}
</style>
</head>
<body>
<div class="container">
<h2>è­·ç…§ / å°èƒè­‰ OCR MRZ</h2>
<input type="file" id="fileInput" accept="image/*">
<button id="cameraBtn">ä½¿ç”¨ç›¸æ©Ÿæ‹ç…§</button>
<canvas id="canvas"></canvas>
<pre id="status">ç‹€æ…‹: ç­‰å¾…æ“ä½œ</pre>
<pre id="result">è¾¨è­˜çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</pre>
</div>

<script>
// ğŸ”‘ é€™è£¡å¡«å…¥ä½ å¾ OCR.Space ç”³è«‹åˆ°çš„ API Key
const OCR_API_KEY = 'K82066068388957';

const fileInput = document.getElementById("fileInput");
const cameraBtn = document.getElementById("cameraBtn");
const canvas = document.getElementById("canvas");
const status = document.getElementById("status");
const resultPre = document.getElementById("result");

// å°‡åœ–ç‰‡è£åˆ‡æˆ MRZ åº•éƒ¨ 1/4 å€åŸŸä¸¦å¢å¼·å°æ¯”
function cropMRZ(img){
    const w = img.width;
    const h = img.height;
    const mrzHeight = h * 0.25; // MRZ é«˜åº¦ç´„1/4
    canvas.width = w;
    canvas.height = mrzHeight;
    const ctx = canvas.getContext("2d");
    ctx.filter = "contrast(150%) grayscale()"; // å¢å¼·å°æ¯”
    ctx.drawImage(img, 0, h - mrzHeight, w, mrzHeight, 0, 0, w, mrzHeight);
    return canvas;
}

// å‘¼å« OCR.Space API (OCRB å°ˆé–€è¾¨è­˜ MRZ)
async function doOCR(canvas){
    status.innerText = "è¾¨è­˜ä¸­...";
    const blob = await new Promise(r=>canvas.toBlob(r,'image/png'));
    const formData = new FormData();
    formData.append("apikey", OCR_API_KEY);
    formData.append("language","OCRB"); // å°ˆé–€ MRZ
    formData.append("isOverlayRequired","false");
    formData.append("file", blob);

    try{
        const res = await fetch("https://api.ocr.space/parse/image",{
            method:"POST",
            body:formData
        });
        const data = await res.json();
        console.log(data);
        if(data.ParsedResults && data.ParsedResults.length>0){
            const text = data.ParsedResults[0].ParsedText.replace(/\s/g,'');
            resultPre.innerText = text;
            status.innerText = "è¾¨è­˜å®Œæˆ âœ…";
            parseMRZ(text);
        }else{
            resultPre.innerText = "OCR å¤±æ•—ï¼Œè«‹æª¢æŸ¥åœ–ç‰‡";
            status.innerText = "OCR å¤±æ•— âŒ";
        }
    }catch(e){
        status.innerText = "OCR å¤±æ•— âŒ";
        console.error(e);
    }
}

// ç°¡å–® MRZ è§£æ (è­·ç…§ã€å°èƒè­‰)
function parseMRZ(text){
    if(text.length < 30) return;
    let result = {};
    if(text[0]=='P'){ // Passport
        result.documentType = "Passport";
        const lines = text.match(/.{1,44}/g); // MRZ 2è¡Œ44å­—
        if(lines && lines.length>=2){
            result.id = lines[0].substring(5,14).replace(/</g,'');
            result.nationality = lines[0].substring(10,13);
            result.name = lines[0].substring(5).split("<<").map(s=>s.replace(/</g,' ')).slice(1).join(" ");
            result.birthday = lines[1].substring(0,6);
            result.sex = lines[1].substring(7,8);
            result.expiry = lines[1].substring(8,14);
        }
    }else{ // å…¶ä»–è­·ç…§/å°èƒè­‰
        result.documentType = "Taiwan Compatriot Permit";
        result.rawMRZ = text;
    }
    // å°‡ç”Ÿæ—¥ã€åˆ°æœŸæ—¥è½‰æˆ YYYY/MM/DD
    if(result.birthday) result.birthday = formatDate(result.birthday);
    if(result.expiry) result.expiry = formatDate(result.expiry);
    if(result.sex) result.sex = result.sex==='M'?'ç”·':'å¥³';
    resultPre.innerText += "\n\nè§£æçµæœ:\n"+JSON.stringify(result,null,2);
}

// MRZ ç”Ÿæ—¥/åˆ°æœŸæ—¥è½‰æ› YYYY/MM/DD
function formatDate(str){
    if(str.length===6){ // YYMMDD
        let year = parseInt(str.slice(0,2));
        year += year>=50?1900:2000;
        return `${year}/${str.slice(2,4)}/${str.slice(4,6)}`;
    }
    return str;
}

// ä¸Šå‚³åœ–ç‰‡
fileInput.onchange = e => {
    if(e.target.files.length===0) return;
    const img = new Image();
    img.onload = async ()=> {
        cropMRZ(img);
        await doOCR(canvas);
    };
    img.src = URL.createObjectURL(e.target.files[0]);
};

// ç›¸æ©Ÿæ‹ç…§
cameraBtn.onclick = async ()=>{
    const video = document.createElement("video");
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        video.srcObject = stream;
        video.play();
        status.innerText = "å°æº–è­·ç…§æˆ–å°èƒè­‰ï¼Œç­‰å¾… 3 ç§’è‡ªå‹•æ‹ç…§...";
        await new Promise(r=>setTimeout(r,3000));
        cropMRZ(video);
        stream.getTracks().forEach(t=>t.stop());
        await doOCR(canvas);
    }catch(e){
        status.innerText = "ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ âŒ";
        console.error(e);
    }
};
</script>
</body>
</html>
















































