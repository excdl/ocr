<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</title>

<script src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.7.0/dist/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mrz@3.0.0/dist/mrz.min.js"></script>

<style>
body {margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial;background:#f5f6fa;}
.container{width:92%;max-width:500px;margin:28px auto;background:white;border-radius:14px;padding:24px;box-shadow:0 8px 28px rgba(0,0,0,0.1);}
button{background:#2979ff;color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-size:16px;width:48%;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:.15s;}
button:active{transform:scale(0.96);}
.upload-box{display:flex;justify-content:space-between;margin-bottom:18px;}
video{width:100%;display:none;border-radius:12px;margin-top:12px;}
pre{background:#222;color:#0f0;padding:12px;border-radius:10px;height:220px;overflow-y:auto;margin-top:20px;}
#loaderMask{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;justify-content:center;align-items:center;z-index:9999;}
.loader{border:6px solid #ddd;border-top:6px solid #2979ff;border-radius:50%;width:60px;height:60px;animation:spin .9s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loader-text{color:white;margin-top:16px;font-size:18px;}
</style>
</head>
<body>

<div id="loaderMask">
  <div>
    <div class="loader"></div>
    <div class="loader-text">æ­£åœ¨è™•ç†ä¸­â€¦</div>
  </div>
</div>

<div class="container">
  <h2>è­·ç…§ / å°èƒè­‰ OCR è¾¨è­˜</h2>

  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*" hidden>
    <button onclick="document.getElementById('fileInput').click()">ğŸ“¤ ä¸Šå‚³åœ–ç‰‡</button>
    <button id="cameraBtn">ğŸ“· ä½¿ç”¨ç›¸æ©Ÿ</button>
  </div>

  <video id="camera" autoplay playsinline></video>
  <button id="capture" style="display:none;width:100%;margin-top:12px;">ğŸ“¸ æ‹ç…§</button>

  <p id="status">æ­£åœ¨è¼‰å…¥ OpenCVâ€¦</p>
  <pre id="result"></pre>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxRw0sVVg_coQBE-JZi2a0WvsEXqCa7lf7u5viiR0qvVpEBWQ8vmCMCbsm5PmFBpLxL/exec";
let openCVReady=false;
cv.onRuntimeInitialized=()=>{openCVReady=true;status.innerText="OpenCV è¼‰å…¥å®Œæˆï¼Œå¯é–‹å§‹è¾¨è­˜ï¼";}
function showLoader(){loaderMask.style.display="flex";}
function hideLoader(){loaderMask.style.display="none";}

/* å½±åƒå‰è™•ç† */
async function preprocessImage(blob){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement("canvas");
      c.width=img.width;c.height=img.height;
      c.getContext("2d").drawImage(img,0,0);
      let src=cv.imread(c);
      cv.cvtColor(src,src,cv.COLOR_RGBA2GRAY);
      cv.threshold(src,src,0,255,cv.THRESH_OTSU+cv.THRESH_BINARY);
      cv.GaussianBlur(src,src,new cv.Size(3,3),0);
      cv.imshow(c,src);src.delete();
      c.toBlob(resolve,"image/jpeg");
    };
    img.src=URL.createObjectURL(blob);
  });
}

/* è£åˆ‡ MRZ */
async function extractMRZ(blob){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const h=img.height,mrzY=h*0.75,mrzH=h*0.25;
      const c=document.createElement("canvas");
      c.width=img.width;c.height=mrzH;
      c.getContext("2d").drawImage(img,0,mrzY,img.width,mrzH,0,0,img.width,mrzH);
      c.toBlob(resolve,"image/jpeg");
    };
    img.src=URL.createObjectURL(blob);
  });
}

/* è­·ç…§ MRZ è¾¨è­˜ */
async function recognizeMRZ(blob){
  return new Promise(resolve=>{
    const fr=new FileReader();
    fr.onload=()=>{
      const parsed=MRZ.parse(fr.result);
      resolve(parsed.valid?parsed:null);
    };
    fr.readAsText(blob);
  });
}

/* OCR */
async function recognizeOCR(blob){
  const worker=await Tesseract.createWorker();
  await worker.loadLanguage("eng+chi_tra");
  await worker.initialize("eng+chi_tra");
  const {data:{text}}=await worker.recognize(blob);
  await worker.terminate();
  return text;
}

/* å°èƒè­‰æ—¥æœŸè§£æï¼ˆç”Ÿæ—¥/æœ‰æ•ˆæœŸ/ç°½ç™¼æ—¥ï¼‰ */
function extractTaiwanPermitDates(text){
  function matchFirst(patterns){for(const p of patterns){const m=text.match(p);if(m)return m[0];}return"";}
  return{
    birthday:matchFirst([/\d{4}[.\-\/]\d{1,2}[.\-\/]\d{1,2}/,/\d{8}/,/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/]),
    expiry:matchFirst([/æœ‰æ•ˆæœŸ[:ï¼š]?\s*\d{4}[.\-\/]\d{1,2}[.\-\/]\d{1,2}/,/\d{8}/,/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/]),
    issued:matchFirst([/ç°½ç™¼æ—¥æœŸ[:ï¼š]?\s*\d{4}[.\-\/]\d{1,2}[.\-\/]\d{1,2}/,/Issued Date[:ï¼š]?\s*\d{8}/,/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/])
  };
}

/* OCR è‹±æ–‡å§“å/ID/è­·ç…§è™Ÿç¢¼ */
function extractNamesAndIDs(text){
  const englishName=(text.match(/[A-Z][A-Z ]{1,30}/g)||[""])[0];
  const id=(text.match(/[A-Z0-9]{6,10}/g)||[""])[0];
  return {englishName,id};
}

/* ä¸»æµç¨‹ */
async function processImage(file){
  if(!openCVReady){alert("OpenCV å°šæœªè¼‰å…¥");return;}
  showLoader();status.innerText="å½±åƒè™•ç†ä¸­â€¦";
  const processed=await preprocessImage(file);
  status.innerText="è­·ç…§ MRZ è¾¨è­˜ä¸­â€¦";
  const mrzBlob=await extractMRZ(processed);
  const mrz=await recognizeMRZ(mrzBlob);
  let data={};
  if(mrz){
    status.innerText="âœ“ æˆåŠŸè¾¨è­˜è­·ç…§ï¼ˆMRZï¼‰";
    data={
      documentType:"Passport",
      name:mrz.fields.surname+" "+mrz.fields.givenNames,
      id:mrz.fields.documentNumber,
      nationality:mrz.fields.nationality,
      birthday:mrz.fields.dateOfBirth,
      expiry:mrz.fields.expirationDate,
      sex:mrz.fields.sex
    };
    result.innerText=JSON.stringify(data,null,2);
  }else{
    status.innerText="å°èƒè­‰ OCR è¾¨è­˜ä¸­â€¦";
    const text=await recognizeOCR(processed);
    const dates=extractTaiwanPermitDates(text);
    const namesIDs=extractNamesAndIDs(text);
    data={
      documentType:"Taiwan Compatriot Permit",
      rawText:text,
      name:namesIDs.englishName,
      id:namesIDs.id,
      birthday:dates.birthday,
      expiry:dates.expiry,
      issued:dates.issued
    };
    result.innerText=text+"\n\n"+JSON.stringify(data,null,2);
  }
  status.innerText="å¯«å…¥ Google Sheetâ€¦";
  await fetch(SCRIPT_URL,{method:"POST",body:JSON.stringify(data)});
  status.innerText="ğŸ‰ å·²å¯«å…¥ Google Sheetï¼";
  hideLoader();
}

/* ä¸Šå‚³ */
fileInput.onchange=e=>{if(e.target.files.length>0)processImage(e.target.files[0]);};

/* ç›¸æ©Ÿ */
const cameraBtn=document.getElementById("cameraBtn");
const camera=document.getElementById("camera");
const capture=document.getElementById("capture");
cameraBtn.onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  camera.srcObject=stream;camera.style.display="block";capture.style.display="block";
};
capture.onclick=()=>{
  const c=document.createElement("canvas");
  c.width=camera.videoWidth;c.height=camera.videoHeight;
  c.getContext("2d").drawImage(camera,0,0);
  c.toBlob(blob=>processImage(blob));
};
</script>
</body>
</html>




